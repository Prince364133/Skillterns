<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Panel</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Inter Font -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            margin: 0;
            padding: 0;
            background-color: #f3f4f6;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
        }
        .container {
            background-color: #ffffff;
            border-radius: 12px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
            overflow: hidden;
            width: 95%;
            max-width: 1200px;
            display: flex;
            flex-direction: column;
            min-height: 80vh;
            margin: 20px;
        }
        @media (min-width: 768px) {
            .container {
                flex-direction: row;
            }
        }
        .admin-section {
            padding: 40px;
            flex: 1;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            background-color: #ffffff;
        }
        .hidden {
            display: none !important;
        }
        .tab-button {
            padding: 12px 24px;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease-in-out;
            background-color: #f0f4f8;
            color: #4a5568;
            border: 1px solid #e2e8f0;
        }
        .tab-button.active {
            background-color: #3b82f6;
            color: #ffffff;
            box-shadow: 0 4px 10px rgba(59, 130, 246, 0.3);
        }
        .form-input {
            width: 100%;
            padding: 12px 16px;
            border: 1px solid #cbd5e0;
            border-radius: 8px;
            font-size: 1rem;
            transition: border-color 0.2s;
        }
        .form-input:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.2);
        }
        .btn-primary {
            background-color: #3b82f6;
            color: white;
            padding: 12px 24px;
            border-radius: 8px;
            font-weight: 600;
            transition: background-color 0.2s, transform 0.1s;
            box-shadow: 0 4px 10px rgba(59, 130, 246, 0.3);
        }
        .btn-primary:hover {
            background-color: #2563eb;
            transform: translateY(-1px);
        }
        .btn-secondary {
            background-color: #6b7280;
            color: white;
            padding: 10px 20px;
            border-radius: 8px;
            font-weight: 500;
            transition: background-color 0.2s;
        }
        .btn-secondary:hover {
            background-color: #4b5563;
        }
        .btn-danger {
            background-color: #ef4444;
            color: white;
            padding: 8px 16px;
            border-radius: 6px;
            font-weight: 500;
            transition: background-color 0.2s;
        }
        .btn-danger:hover {
            background-color: #dc2626;
        }
        .btn-edit {
            background-color: #22c55e;
            color: white;
            padding: 8px 16px;
            border-radius: 6px;
            font-weight: 500;
            transition: background-color 0.2s;
        }
        .btn-edit:hover {
            background-color: #16a34a;
        }
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(255, 255, 255, 0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        .spinner {
            border: 8px solid #f3f3f3;
            border-top: 8px solid #3b82f6;
            border-radius: 50%;
            width: 60px;
            height: 60px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.6);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        .modal-content {
            background-color: white;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.2);
            max-width: 600px; /* Increased for edit form */
            width: 90%;
            max-height: 90vh; /* Limit height to 90% of viewport */
            overflow-y: auto; /* Enable vertical scrolling */
            text-align: left; /* Align text left for forms */
        }
        /* Mobile responsive adjustments */
        @media (max-width: 768px) {
            .modal-content {
                width: 95%;
                padding: 20px;
                max-height: 95vh;
            }
            .container {
                width: 100%;
                margin: 10px;
                min-height: 90vh;
            }
            .admin-section {
                padding: 20px;
            }
            .data-table {
                font-size: 0.8rem;
            }
            .data-table th, .data-table td {
                padding: 8px 10px;
            }
            .btn-primary, .btn-secondary {
                padding: 10px 16px;
                font-size: 0.9rem;
            }
            .form-input {
                padding: 10px 12px;
                font-size: 0.9rem;
            }
        }
        .mcq-option-group {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 10px;
        }
        .mcq-option-group input[type="radio"] {
            margin-right: 5px;
        }
        .mcq-option-group input[type="text"] {
            flex-grow: 1;
        }
        .mcq-question-card {
            background-color: #f9fafb;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
        }
        .mcq-question-card p {
            margin-bottom: 8px;
        }
        .mcq-question-card ul {
            list-style: none;
            padding: 0;
        }
        .mcq-question-card li {
            margin-bottom: 4px;
        }
        .mcq-question-card .correct-answer {
            font-weight: 600;
            color: #22c55e;
        }
        /* Table styles */
        .table-container {
            overflow-x: auto;
            width: 100%;
        }
        .data-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        .data-table th, .data-table td {
            padding: 12px 15px;
            border-bottom: 1px solid #e2e8f0;
            text-align: left;
        }
        .data-table th {
            background-color: #f8fafc;
            font-weight: 600;
            color: #4a5568;
            text-transform: uppercase;
            font-size: 0.85rem;
        }
        .data-table tr:last-child td {
            border-bottom: none;
        }
        .data-table tbody tr:hover {
            background-color: #f0f4f8;
        }
        /* Additional mobile responsive table improvements */
        @media (max-width: 768px) {
            .table-container {
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
            }
            .data-table {
                min-width: 600px; /* Ensure table doesn't get too cramped */
            }
            .mcq-question-card {
                padding: 10px;
            }
            .mcq-option-group {
                flex-direction: column;
                align-items: flex-start;
                gap: 5px;
            }
            .mcq-option-group input[type="text"] {
                width: 100%;
            }
            .tab-button {
                padding: 8px 16px;
                font-size: 0.9rem;
                margin-bottom: 5px;
            }
            .flex.gap-4 {
                flex-direction: column;
                gap: 10px;
            }
            .flex.gap-4 > * {
                width: 100%;
            }
            .admin-tab-content {
                padding: 0 10px;
            }
            .admin-tab-content h2 {
                font-size: 1.5rem;
            }
            .admin-tab-content h3 {
                font-size: 1.2rem;
            }
        }
    </style>
</head>
<body>
    <div class="loading-overlay" id="loadingOverlay">
        <div class="spinner"></div>
    </div>

    <div class="container">
        <!-- Admin Panel Section - Now always visible -->
        <div id="adminSection" class="admin-section p-8 md:p-12">
            <div class="flex justify-between items-center w-full mb-8">
                <h1 class="text-4xl font-extrabold text-gray-900">Admin Dashboard</h1>
                <button id="resetAdminViewBtn" class="btn-secondary">Reset Admin View</button>
            </div>

            <p class="text-gray-600 mb-6">Welcome, Administrator! Session ID: <span id="adminUserIdDisplay" class="font-mono text-sm"></span></p>

            <div class="flex flex-wrap gap-2 mb-8">
                <button id="showCreateCategoryBtn" class="tab-button active">Create Category</button>
                <button id="showManageCategoriesBtn" class="tab-button">Manage Categories</button>
                <button id="showCreateTestBtn" class="tab-button">Create Test</button>
                <button id="showManageTestsBtn" class="tab-button">Manage Tests</button>
                <button id="showCreatePostBtn" class="tab-button">Create Post</button>
                <button id="showManagePostsBtn" class="tab-button">Manage Posts</button>
                <button id="showManageUsersBtn" class="tab-button">Manage Users</button>
                <button id="migrateDataBtn" class="tab-button" style="background-color: #f59e0b; color: white;">Migrate Data</button>
            </div>

            <!-- Create Category Section -->
            <div id="createCategorySection" class="admin-tab-content w-full max-w-2xl">
                <h2 class="text-2xl font-semibold text-gray-800 mb-4">Create New Category</h2>
                <form id="createCategoryForm" class="space-y-4">
                    <div>
                        <label for="categoryName" class="block text-sm font-medium text-gray-700 mb-1">Category Name</label>
                        <input type="text" id="categoryName" class="form-input" placeholder="e.g., Science, History" required>
                    </div>
                    <div>
                        <label for="categoryType" class="block text-sm font-medium text-gray-700 mb-1">Category Type</label>
                        <select id="categoryType" class="form-input" required>
                            <option value="test">Test Category</option>
                            <option value="post">Post Category</option>
                        </select>
                    </div>
                    <button type="submit" class="btn-primary w-full">Add Category</button>
                </form>
            </div>

            <!-- Manage Categories Section -->
            <div id="manageCategoriesSection" class="admin-tab-content w-full max-w-4xl hidden">
                <h2 class="text-2xl font-semibold text-gray-800 mb-4">Manage Categories</h2>
                <h3 class="text-xl font-semibold text-gray-800 mb-2">Test Categories</h3>
                <div class="table-container mb-8">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Category Name</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="categoriesTableBody">
                            <!-- Test categories will be loaded here -->
                        </tbody>
                    </table>
                </div>
                <h3 class="text-xl font-semibold text-gray-800 mb-2">Post Categories</h3>
                <div class="table-container">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Category Name</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="postCategoriesTableBody">
                            <!-- Post categories will be loaded here -->
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Create MCQ Test Section -->
            <div id="createTestSection" class="admin-tab-content w-full max-w-3xl hidden">
                <h2 class="text-2xl font-semibold text-gray-800 mb-4">Create New MCQ Test</h2>
                <form id="createTestForm" class="space-y-4">
                    <div>
                        <label for="testTitle" class="block text-sm font-medium text-gray-700 mb-1">Test Title</label>
                        <input type="text" id="testTitle" class="form-input" placeholder="e.g., Basic Physics Quiz" required>
                    </div>
                    <div>
                        <label for="testCategory" class="block text-sm font-medium text-gray-700 mb-1">Select Category</label>
                        <select id="testCategory" class="form-input" required>
                            <option value="">-- Select a Category --</option>
                            <!-- Categories will be loaded here dynamically -->
                        </select>
                    </div>

                    <h3 class="text-xl font-semibold text-gray-800 mt-6 mb-3">Questions</h3>
                    <div id="questionsContainer" class="space-y-4 border p-4 rounded-lg bg-gray-50">
                        <!-- Initial question template -->
                        <div class="mcq-question-card" data-question-index="0">
                            <label class="block text-sm font-medium text-gray-700 mb-1">Question 1</label>
                            <input type="text" placeholder="Question text" class="form-input question-text mb-2" required>
                            <div class="mcq-option-group">
                                <input type="radio" name="correct-0" value="A" required>
                                <input type="text" placeholder="Option A" class="form-input option-text" data-option="A" required>
                            </div>
                            <div class="mcq-option-group">
                                <input type="radio" name="correct-0" value="B">
                                <input type="text" placeholder="Option B" class="form-input option-text" data-option="B" required>
                            </div>
                            <div class="mcq-option-group">
                                <input type="radio" name="correct-0" value="C">
                                <input type="text" placeholder="Option C" class="form-input option-text" data-option="C" required>
                            </div>
                            <div class="mcq-option-group">
                                <input type="radio" name="correct-0" value="D">
                                <input type="text" placeholder="Option D" class="form-input option-text" data-option="D" required>
                            </div>
                            <button type="button" class="btn-danger remove-question-btn mt-2 hidden">Remove Question</button>
                        </div>
                    </div>
                    <button type="button" id="addQuestionBtn" class="btn-secondary w-full">Add Another Question</button>
                    <button type="submit" class="btn-primary w-full mt-6">Create Test</button>
                </form>
            </div>

            <!-- Manage Tests Section -->
            <div id="manageTestsSection" class="admin-tab-content w-full max-w-4xl hidden">
                <h2 class="text-2xl font-semibold text-gray-800 mb-4">Manage Tests</h2>
                <div class="mb-4">
                    <label for="filterTestCategory" class="block text-sm font-medium text-gray-700 mb-1">Filter by Category</label>
                    <select id="filterTestCategory" class="form-input w-full md:w-1/2">
                        <option value="">All Categories</option>
                        <!-- Categories will be loaded here dynamically -->
                    </select>
                </div>
                <div class="table-container">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Test Title</th>
                                <th>Category</th>
                                <th>Questions</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="testsTableBody">
                            <!-- Tests will be loaded here -->
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Create Post Section -->
            <div id="createPostSection" class="admin-tab-content w-full max-w-3xl hidden">
                <h2 class="text-2xl font-semibold text-gray-800 mb-4">Create New Study Post</h2>
                <form id="createPostForm" class="space-y-4">
                    <div>
                        <label for="postTitle" class="block text-sm font-medium text-gray-700 mb-1">Post Title</label>
                        <input type="text" id="postTitle" class="form-input" placeholder="e.g., Introduction to JavaScript" required>
                    </div>
                    <div>
                        <label for="postCategory" class="block text-sm font-medium text-gray-700 mb-1">Select Category</label>
                        <select id="postCategory" class="form-input" required>
                            <option value="">-- Select a Category --</option>
                            <!-- Post categories will be loaded here dynamically -->
                        </select>
                    </div>
                    <div>
                        <label for="postDescription" class="block text-sm font-medium text-gray-700 mb-1">Description</label>
                        <textarea id="postDescription" class="form-input" rows="4" placeholder="Enter a detailed description of the study material..." required></textarea>
                    </div>
                    <div>
                        <label for="postLinks" class="block text-sm font-medium text-gray-700 mb-1">Study Links (one per line)</label>
                        <textarea id="postLinks" class="form-input" rows="3" placeholder="https://www.youtube.com/watch?v=example&#10;https://example.com/resource&#10;https://docs.example.com"></textarea>
                        <p class="text-sm text-gray-500 mt-1">Add YouTube links, documentation, or any other study resources. One link per line.</p>
                    </div>
                    <button type="submit" class="btn-primary w-full">Create Post</button>
                </form>
            </div>

            <!-- Manage Posts Section -->
            <div id="managePostsSection" class="admin-tab-content w-full max-w-4xl hidden">
                <h2 class="text-2xl font-semibold text-gray-800 mb-4">Manage Study Posts</h2>
                <div class="mb-4">
                    <label for="filterPostCategory" class="block text-sm font-medium text-gray-700 mb-1">Filter by Category</label>
                    <select id="filterPostCategory" class="form-input w-full md:w-1/2">
                        <option value="">All Categories</option>
                        <!-- Post categories will be loaded here dynamically -->
                    </select>
                </div>
                <div class="table-container">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Post Title</th>
                                <th>Category</th>
                                <th>Description</th>
                                <th>Links</th>
                                <th>Created At</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="postsTableBody">
                            <!-- Posts will be loaded here -->
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Manage Users Section -->
            <div id="manageUsersSection" class="admin-tab-content w-full max-w-4xl hidden">
                <h2 class="text-2xl font-semibold text-gray-800 mb-4">Manage Student Users</h2>
                <p class="text-gray-600 mb-4">View and manage registered student users. Students are automatically added when they sign up through the student portal.</p>
                <div class="table-container">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Name</th>
                                <th>Email</th>
                                <th>Phone Number</th>
                                <th>User ID</th>
                                <th>Registration Date</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="usersTableBody">
                            <!-- Users will be loaded here -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Custom Modal for Alerts/Confirmations -->
    <div id="customModal" class="modal hidden">
        <div class="modal-content">
            <h3 id="modalTitle" class="text-xl font-semibold mb-4"></h3>
            <p id="modalMessage" class="text-gray-700 mb-6"></p>
            <div class="flex justify-center gap-4">
                <button id="modalConfirmBtn" class="btn-primary hidden">Confirm</button>
                <button id="modalCloseBtn" class="btn-secondary">Close</button>
            </div>
        </div>
    </div>

    <!-- Edit Test Modal -->
    <div id="editTestModal" class="modal hidden">
        <div class="modal-content">
            <h3 class="text-2xl font-semibold text-gray-800 mb-4">Edit MCQ Test</h3>
            <form id="editTestForm" class="space-y-4">
                <input type="hidden" id="editTestId">
                <div>
                    <label for="editTestTitle" class="block text-sm font-medium text-gray-700 mb-1">Test Title</label>
                    <input type="text" id="editTestTitle" class="form-input" required>
                </div>
                <div>
                    <label for="editTestCategory" class="block text-sm font-medium text-gray-700 mb-1">Select Category</label>
                    <select id="editTestCategory" class="form-input" required>
                        <option value="">-- Select a Category --</option>
                        <!-- Categories will be loaded here dynamically -->
                    </select>
                </div>

                <h3 class="text-xl font-semibold text-gray-800 mt-6 mb-3">Questions</h3>
                <div id="editQuestionsContainer" class="space-y-4 border p-4 rounded-lg bg-gray-50">
                    <!-- Questions will be loaded here dynamically for editing -->
                </div>

    <!-- Edit Post Modal -->
    <div id="editPostModal" class="modal hidden">
        <div class="modal-content">
            <h3 class="text-2xl font-semibold text-gray-800 mb-4">Edit Study Post</h3>
            <form id="editPostForm" class="space-y-4">
                <input type="hidden" id="editPostId">
                <div>
                    <label for="editPostTitle" class="block text-sm font-medium text-gray-700 mb-1">Post Title</label>
                    <input type="text" id="editPostTitle" class="form-input" required>
                </div>
                <div>
                    <label for="editPostCategory" class="block text-sm font-medium text-gray-700 mb-1">Select Category</label>
                    <select id="editPostCategory" class="form-input" required>
                        <option value="">-- Select a Category --</option>
                        <!-- Post categories will be loaded here dynamically -->
                    </select>
                </div>
                <div>
                    <label for="editPostDescription" class="block text-sm font-medium text-gray-700 mb-1">Description</label>
                    <textarea id="editPostDescription" class="form-input" rows="4" required></textarea>
                </div>
                <div>
                    <label for="editPostLinks" class="block text-sm font-medium text-gray-700 mb-1">Study Links (one per line)</label>
                    <textarea id="editPostLinks" class="form-input" rows="3"></textarea>
                    <p class="text-sm text-gray-500 mt-1">Add YouTube links, documentation, or any other study resources. One link per line.</p>
                </div>
                <div class="flex gap-4">
                    <button type="submit" class="btn-primary flex-1">Update Post</button>
                    <button type="button" id="cancelEditPostBtn" class="btn-secondary flex-1">Cancel</button>
                </div>
            </form>
        </div>
    </div>
                <button type="button" id="addEditQuestionBtn" class="btn-secondary w-full">Add Another Question</button>
                <div class="flex justify-end gap-4 mt-6">
                    <button type="button" id="cancelEditTestBtn" class="btn-secondary">Cancel</button>
                    <button type="submit" class="btn-primary">Save Changes</button>
                </div>
            </form>
        </div>
    </div>

    <script type="module">
        // Firebase imports
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import {
            getFirestore,
            collection,
            addDoc,
            doc,
            getDoc,
            getDocs,
            setDoc,
            updateDoc,
            deleteDoc,
            onSnapshot
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Global variables for Firebase instances and data
        let app;
        let db;
        let currentUserId = 'admin_session_' + Math.random().toString(36).substring(2, 15); // Unique ID for current session
        let testCategories = []; // Test categories
        let postCategories = []; // Post categories
        let allTests = []; // To store all tests for filtering and editing
        let allPosts = []; // To store all posts for filtering and editing

        // Global variables for Canvas environment
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        // Hardcoded Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyAGPyk54-zJUE6iV3872XKLIq9OW3KCM6o",
            authDomain: "skillyterns.firebaseapp.com",
            databaseURL: "https://skillyterns-default-rtdb.firebaseio.com",
            projectId: "skillyterns",
            storageBucket: "skillyterns.firebasestorage.app",
            messagingSenderId: "1034584532277",
            measurementId: "G-5G2GCWYEPL"
        };

        // UI Elements
        const loadingOverlay = document.getElementById('loadingOverlay');
        const adminSection = document.getElementById('adminSection');
        const resetAdminViewBtn = document.getElementById('resetAdminViewBtn');
        const adminUserIdDisplay = document.getElementById('adminUserIdDisplay');

        // Admin Panel Tabs
        const showCreateCategoryBtn = document.getElementById('showCreateCategoryBtn');
        const showManageCategoriesBtn = document.getElementById('showManageCategoriesBtn');
        const showCreateTestBtn = document.getElementById('showCreateTestBtn');
        const showManageTestsBtn = document.getElementById('showManageTestsBtn');
        const showCreatePostBtn = document.getElementById('showCreatePostBtn');
        const showManagePostsBtn = document.getElementById('showManagePostsBtn');
        const showManageUsersBtn = document.getElementById('showManageUsersBtn'); // New button

        const createCategorySection = document.getElementById('createCategorySection');
        const manageCategoriesSection = document.getElementById('manageCategoriesSection');
        const createTestSection = document.getElementById('createTestSection');
        const manageTestsSection = document.getElementById('manageTestsSection');
        const createPostSection = document.getElementById('createPostSection');
        const managePostsSection = document.getElementById('managePostsSection');
        const manageUsersSection = document.getElementById('manageUsersSection'); // New section

        // Create Category Form
        const createCategoryForm = document.getElementById('createCategoryForm');
        const categoryNameInput = document.getElementById('categoryName');
        const categoryTypeSelect = document.getElementById('categoryType');

        // Manage Categories Table
        const categoriesTableBody = document.getElementById('categoriesTableBody');

        // Create Test Form
        const createTestForm = document.getElementById('createTestForm');
        const testTitleInput = document.getElementById('testTitle');
        const testCategorySelect = document.getElementById('testCategory');
        const questionsContainer = document.getElementById('questionsContainer');
        const addQuestionBtn = document.getElementById('addQuestionBtn');
        let questionCounter = 0; // To keep track of questions for unique radio button names

        // Manage Tests Section
        const filterTestCategorySelect = document.getElementById('filterTestCategory');
        const testsTableBody = document.getElementById('testsTableBody');

        // Create Post Form
        const createPostForm = document.getElementById('createPostForm');
        const postTitleInput = document.getElementById('postTitle');
        const postCategorySelect = document.getElementById('postCategory');
        const postDescriptionInput = document.getElementById('postDescription');
        const postLinksInput = document.getElementById('postLinks');

        // Manage Posts Section
        const filterPostCategorySelect = document.getElementById('filterPostCategory');
        const postsTableBody = document.getElementById('postsTableBody');

        // Manage Users Section
        const usersTableBody = document.getElementById('usersTableBody');

        const migrateDataBtn = document.getElementById('migrateDataBtn');

        // Custom Modal Elements (for alerts/confirmations)
        const customModal = document.getElementById('customModal');
        const modalTitle = document.getElementById('modalTitle');
        const modalMessage = document.getElementById('modalMessage');
        const modalConfirmBtn = document.getElementById('modalConfirmBtn');
        const modalCloseBtn = document.getElementById('modalCloseBtn');

        // Edit Test Modal Elements
        const editTestModal = document.getElementById('editTestModal');
        const editTestForm = document.getElementById('editTestForm');
        const editTestIdInput = document.getElementById('editTestId');
        const editTestTitleInput = document.getElementById('editTestTitle');
        const editTestCategorySelect = document.getElementById('editTestCategory');
        const editQuestionsContainer = document.getElementById('editQuestionsContainer');
        const addEditQuestionBtn = document.getElementById('addEditQuestionBtn');
        const cancelEditTestBtn = document.getElementById('cancelEditTestBtn');
        let editQuestionCounter = 0; // To track questions in edit modal

        // Edit Post Modal Elements
        const editPostModal = document.getElementById('editPostModal');
        const editPostForm = document.getElementById('editPostForm');
        const editPostIdInput = document.getElementById('editPostId');
        const editPostTitleInput = document.getElementById('editPostTitle');
        const editPostCategorySelect = document.getElementById('editPostCategory');
        const editPostDescriptionInput = document.getElementById('editPostDescription');
        const editPostLinksInput = document.getElementById('editPostLinks');
        const cancelEditPostBtn = document.getElementById('cancelEditPostBtn');

        /**
         * Shows the loading overlay.
         */
        function showLoading() {
            loadingOverlay.classList.remove('hidden');
        }

        /**
         * Hides the loading overlay.
         */
        function hideLoading() {
            loadingOverlay.classList.add('hidden');
        }

        /**
         * Displays a custom modal message.
         * @param {string} title - The title of the modal.
         * @param {string} message - The message to display.
         * @param {boolean} showConfirm - Whether to show the confirm button.
         * @returns {Promise<boolean>} - Resolves true if confirmed, false if closed.
         */
        function showCustomModal(title, message, showConfirm = false) {
            return new Promise((resolve) => {
                modalTitle.textContent = title;
                modalMessage.textContent = message;
                modalConfirmBtn.classList.toggle('hidden', !showConfirm);
                customModal.classList.remove('hidden');

                const closeModal = () => {
                    customModal.classList.add('hidden');
                    modalConfirmBtn.removeEventListener('click', onConfirm);
                    modalCloseBtn.removeEventListener('click', onCancel);
                };

                const onConfirm = () => {
                    closeModal();
                    resolve(true);
                };

                const onCancel = () => {
                    closeModal();
                    resolve(false);
                };

                modalConfirmBtn.addEventListener('click', onConfirm);
                modalCloseBtn.addEventListener('click', onCancel);
            });
        }

        /**
         * Initializes Firebase and sets up the admin panel directly.
         */
        async function initializeFirebase() {
            showLoading();
            try {
                console.log("Canvas App ID:", appId);
                console.log("Firebase Config:", firebaseConfig);

                app = initializeApp(firebaseConfig);
                db = getFirestore(app);

                adminUserIdDisplay.textContent = currentUserId; // Display the session ID

                console.log("Authentication removed. Directly showing admin section.");
                showAdminSection();
                setupFirestoreListeners(); // Start listening to data changes
            } catch (error) {
                console.error("Error initializing Firebase:", error);
                showCustomModal("Error", "Failed to initialize application. Please check your Firebase configuration and network.");
            } finally {
                hideLoading();
            }
        }

        /**
         * Shows the admin panel.
         */
        function showAdminSection() {
            adminSection.classList.remove('hidden');
            // Ensure a tab is active by default
            switchAdminTab('createCategorySection');
            showCreateCategoryBtn.classList.add('active');
            showManageCategoriesBtn.classList.remove('active');
            showCreateTestBtn.classList.remove('active');
            showManageTestsBtn.classList.remove('active');
            showManageUsersBtn.classList.remove('active');
        }

        /**
         * Handles resetting the admin view (effectively a "logout" without actual auth).
         */
        resetAdminViewBtn.addEventListener('click', () => {
            showCustomModal("Admin View Reset", "The admin view has been reset. Note: Authentication is disabled, so a new session ID will be generated upon reload.");
            location.reload();
        });

        /**
         * Switches between admin panel tabs.
         * @param {string} tabId - The ID of the tab content to show.
         */
        function switchAdminTab(tabId) {
            // Hide all tab contents
            document.querySelectorAll('.admin-tab-content').forEach(tabContent => {
                tabContent.classList.add('hidden');
            });
            // Deactivate all tab buttons
            document.querySelectorAll('.tab-button').forEach(button => {
                button.classList.remove('active');
            });

            // Show the selected tab content
            document.getElementById(tabId).classList.remove('hidden');

            // Activate the corresponding tab button
            if (tabId === 'createCategorySection') showCreateCategoryBtn.classList.add('active');
            else if (tabId === 'manageCategoriesSection') showManageCategoriesBtn.classList.add('active');
            else if (tabId === 'createTestSection') showCreateTestBtn.classList.add('active');
            else if (tabId === 'manageTestsSection') showManageTestsBtn.classList.add('active');
            else if (tabId === 'createPostSection') showCreatePostBtn.classList.add('active');
            else if (tabId === 'managePostsSection') showManagePostsBtn.classList.add('active');
            else if (tabId === 'manageUsersSection') showManageUsersBtn.classList.add('active');
        }

        // Event listeners for tab buttons
        showCreateCategoryBtn.addEventListener('click', () => switchAdminTab('createCategorySection'));
        showManageCategoriesBtn.addEventListener('click', () => switchAdminTab('manageCategoriesSection'));
        showCreateTestBtn.addEventListener('click', () => switchAdminTab('createTestSection'));
        showManageTestsBtn.addEventListener('click', () => switchAdminTab('manageTestsSection'));
        showCreatePostBtn.addEventListener('click', () => switchAdminTab('createPostSection'));
        showManagePostsBtn.addEventListener('click', () => switchAdminTab('managePostsSection'));
        showManageUsersBtn.addEventListener('click', () => switchAdminTab('manageUsersSection'));
        migrateDataBtn.addEventListener('click', migrateOldTestData);

        /**
         * Sets up real-time listeners for Firestore collections.
         */
        function setupFirestoreListeners() {
            // Listen for test categories changes
            const testCategoriesCollectionRef = collection(db, `artifacts/${appId}/public/data/categories`);
            onSnapshot(testCategoriesCollectionRef, (snapshot) => {
                testCategories = [];
                snapshot.forEach(doc => {
                    testCategories.push({ id: doc.id, ...doc.data() });
                });
                renderTestCategoriesTable();
                populateCategoryDropdowns();
                populateEditTestCategoryDropdown(); // Also update edit modal dropdown
            }, (error) => {
                console.error("Error listening to test categories:", error);
                showCustomModal("Error", "Failed to load test categories.");
            });

            // Listen for post categories changes
            const postCategoriesCollectionRef = collection(db, `artifacts/${appId}/public/data/postCategories`);
            onSnapshot(postCategoriesCollectionRef, (snapshot) => {
                postCategories = [];
                snapshot.forEach(doc => {
                    postCategories.push({ id: doc.id, ...doc.data() });
                });
                renderPostCategoriesTable();
                populateCategoryDropdowns();
                populateEditPostCategoryDropdown(); // Also update edit post modal dropdown
            }, (error) => {
                console.error("Error listening to post categories:", error);
                showCustomModal("Error", "Failed to load post categories.");
            });

            // Listen for tests changes
            const testsCollectionRef = collection(db, `artifacts/${appId}/public/data/tests`);
            onSnapshot(testsCollectionRef, (snapshot) => {
                allTests = []; // Update allTests array
                snapshot.forEach(doc => {
                    allTests.push({ id: doc.id, ...doc.data() });
                });
                renderTestsTable(allTests); // Render with all tests, filter will apply
            }, (error) => {
                console.error("Error listening to tests:", error);
                showCustomModal("Error", "Failed to load tests.");
            });

            // Listen for student users changes
            const studentsCollectionRef = collection(db, `artifacts/${appId}/public/data/students`);
            onSnapshot(studentsCollectionRef, (snapshot) => {
                const students = [];
                snapshot.forEach(doc => {
                    students.push({ id: doc.id, ...doc.data() });
                });
                renderUsersTable(students);
            }, (error) => {
                console.error("Error listening to students:", error);
                showCustomModal("Error", "Failed to load student data.");
            });

            // Listen for posts changes
            const postsCollectionRef = collection(db, `artifacts/${appId}/public/data/posts`);
            onSnapshot(postsCollectionRef, (snapshot) => {
                allPosts = [];
                snapshot.forEach(doc => {
                    allPosts.push({ id: doc.id, ...doc.data() });
                });
                renderPostsTable(allPosts);
            }, (error) => {
                console.error("Error listening to posts:", error);
                showCustomModal("Error", "Failed to load posts.");
            });
        }

        /**
         * Handles creation of a new category.
         */
        createCategoryForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            showLoading();
            const categoryName = categoryNameInput.value.trim();
            const categoryType = categoryTypeSelect.value;

            if (!categoryName) {
                showCustomModal("Input Error", "Category name cannot be empty.");
                hideLoading();
                return;
            }

            try {
                const collectionPath = categoryType === 'post' ? `artifacts/${appId}/public/data/postCategories` : `artifacts/${appId}/public/data/categories`;
                const categoriesCollectionRef = collection(db, collectionPath);
                await addDoc(categoriesCollectionRef, { title: categoryName, createdAt: new Date() });
                showCustomModal("Success", `Category "${categoryName}" added successfully!`);
                createCategoryForm.reset();
            } catch (error) {
                console.error("Error adding category:", error);
                showCustomModal("Error", "Failed to add category.");
            } finally {
                hideLoading();
            }
        });

        /**
         * Renders the categories in the manage categories table.
         */
        function renderTestCategoriesTable() {
            categoriesTableBody.innerHTML = '';
            if (testCategories.length === 0) {
                categoriesTableBody.innerHTML = '<tr><td colspan="2" class="text-center text-gray-500">No test categories found.</td></tr>';
                return;
            }
            testCategories.forEach(category => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${category.title}</td>
                    <td>
                        <button class="btn-danger delete-test-category-btn" data-id="${category.id}">Delete</button>
                    </td>
                `;
                categoriesTableBody.appendChild(row);
            });

            document.querySelectorAll('.delete-test-category-btn').forEach(button => {
                button.addEventListener('click', async (e) => {
                    const categoryId = e.target.dataset.id;
                    const categoryTitle = e.target.closest('tr').querySelector('td:first-child').textContent;
                    const confirmDelete = await showCustomModal("Confirm Delete", `Delete test category "${categoryTitle}"? This cannot be undone.`, true);
                    if (confirmDelete) {
                        await deleteTestCategory(categoryId);
                    }
                });
            });
        }

        function renderPostCategoriesTable() {
            const postCategoriesTableBody = document.getElementById('postCategoriesTableBody');
            postCategoriesTableBody.innerHTML = '';
            if (postCategories.length === 0) {
                postCategoriesTableBody.innerHTML = '<tr><td colspan="2" class="text-center text-gray-500">No post categories found.</td></tr>';
                return;
            }
            postCategories.forEach(category => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${category.title}</td>
                    <td>
                        <button class="btn-danger delete-post-category-btn" data-id="${category.id}">Delete</button>
                    </td>
                `;
                postCategoriesTableBody.appendChild(row);
            });

            document.querySelectorAll('.delete-post-category-btn').forEach(button => {
                button.addEventListener('click', async (e) => {
                    const categoryId = e.target.dataset.id;
                    const categoryTitle = e.target.closest('tr').querySelector('td:first-child').textContent;
                    const confirmDelete = await showCustomModal("Confirm Delete", `Delete post category "${categoryTitle}"? This cannot be undone.`, true);
                    if (confirmDelete) {
                        await deletePostCategory(categoryId);
                    }
                });
            });
        }

        /**
         * Deletes a category from Firestore.
         * @param {string} categoryId - The ID of the category to delete.
         */
        async function deleteTestCategory(categoryId) {
            showLoading();
            try {
                const categoryDocRef = doc(db, `artifacts/${appId}/public/data/categories`, categoryId);
                await deleteDoc(categoryDocRef);
                showCustomModal("Success", "Test category deleted successfully!");
            } catch (error) {
                console.error("Error deleting category:", error);
                showCustomModal("Error", "Failed to delete test category.");
            } finally {
                hideLoading();
            }
        }

        async function deletePostCategory(categoryId) {
            showLoading();
            try {
                const categoryDocRef = doc(db, `artifacts/${appId}/public/data/postCategories`, categoryId);
                await deleteDoc(categoryDocRef);
                showCustomModal("Success", "Post category deleted successfully!");
            } catch (error) {
                console.error("Error deleting post category:", error);
                showCustomModal("Error", "Failed to delete post category.");
            } finally {
                hideLoading();
            }
        }

        /**
         * Populates the category dropdowns in create test and filter sections.
         */
        function populateCategoryDropdowns() {
            // Test categories dropdowns
            testCategorySelect.innerHTML = `<option value="">-- Select a Category --</option>`;
            filterTestCategorySelect.innerHTML = `<option value="">All Categories</option>`;
            testCategories.forEach(category => {
                const optCreate = document.createElement('option');
                optCreate.value = category.id;
                optCreate.textContent = category.title;
                testCategorySelect.appendChild(optCreate);

                const optFilter = document.createElement('option');
                optFilter.value = category.title; // filter by name
                optFilter.textContent = category.title;
                filterTestCategorySelect.appendChild(optFilter);
            });

            // Post categories dropdowns
            postCategorySelect.innerHTML = `<option value="">-- Select a Category --</option>`;
            filterPostCategorySelect.innerHTML = `<option value="">All Categories</option>`;
            postCategories.forEach(category => {
                const optCreate = document.createElement('option');
                optCreate.value = category.id;
                optCreate.textContent = category.title;
                postCategorySelect.appendChild(optCreate);

                const optFilter = document.createElement('option');
                optFilter.value = category.title; // filter by name
                optFilter.textContent = category.title;
                filterPostCategorySelect.appendChild(optFilter);
            });
        }

        /**
         * Populates the category dropdown in the edit test modal.
         */
        function populateEditTestCategoryDropdown() {
            editTestCategorySelect.innerHTML = `<option value="">-- Select a Category --</option>`;
            testCategories.forEach(category => {
                const option = document.createElement('option');
                option.value = category.id;
                option.textContent = category.title;
                editTestCategorySelect.appendChild(option);
            });
        }

        /**
         * Populates the category dropdown in the edit post modal.
         */
        function populateEditPostCategoryDropdown() {
            editPostCategorySelect.innerHTML = `<option value="">-- Select a Category --</option>`;
            postCategories.forEach(category => {
                const option = document.createElement('option');
                option.value = category.id;
                option.textContent = category.title;
                editPostCategorySelect.appendChild(option);
            });
        }

        /**
         * Adds a new MCQ question input block to the form.
         * @param {HTMLElement} container - The container to add the question to.
         * @param {number} index - The index for naming radio buttons.
         * @param {Object} [questionData] - Optional existing question data to pre-fill.
         */
        function addQuestionBlock(container, index, questionData = {}) {
            const newQuestionHtml = `
                <div class="mcq-question-card" data-question-index="${index}">
                    <label class="block text-sm font-medium text-gray-700 mb-1">Question ${index + 1}</label>
                    <input type="text" placeholder="Question text" class="form-input question-text mb-2" value="${questionData.questionText || ''}" required>
                    <div class="mcq-option-group">
                        <input type="radio" name="correct-${index}" value="A" ${questionData.correctAnswerIndex === 0 ? 'checked' : ''} required>
                        <input type="text" placeholder="Option A" class="form-input option-text" data-option="A" value="${questionData.options && questionData.options[0] ? questionData.options[0] : ''}" required>
                    </div>
                    <div class="mcq-option-group">
                        <input type="radio" name="correct-${index}" value="B" ${questionData.correctAnswerIndex === 1 ? 'checked' : ''}>
                        <input type="text" placeholder="Option B" class="form-input option-text" data-option="B" value="${questionData.options && questionData.options[1] ? questionData.options[1] : ''}" required>
                    </div>
                    <div class="mcq-option-group">
                        <input type="radio" name="correct-${index}" value="C" ${questionData.correctAnswerIndex === 2 ? 'checked' : ''}>
                        <input type="text" placeholder="Option C" class="form-input option-text" data-option="C" value="${questionData.options && questionData.options[2] ? questionData.options[2] : ''}" required>
                    </div>
                    <div class="mcq-option-group">
                        <input type="radio" name="correct-${index}" value="D" ${questionData.correctAnswerIndex === 3 ? 'checked' : ''}>
                        <input type="text" placeholder="Option D" class="form-input option-text" data-option="D" value="${questionData.options && questionData.options[3] ? questionData.options[3] : ''}" required>
                    </div>
                    <button type="button" class="btn-danger remove-question-btn mt-2 ${index === 0 ? 'hidden' : ''}">Remove Question</button>
                </div>
            `;
            container.insertAdjacentHTML('beforeend', newQuestionHtml);
            updateRemoveButtonsVisibility(container);
        }

        // Add question button for Create Test form
        addQuestionBtn.addEventListener('click', () => {
            questionCounter++;
            addQuestionBlock(questionsContainer, questionCounter);
        });

        // Add question button for Edit Test form
        addEditQuestionBtn.addEventListener('click', () => {
            editQuestionCounter++;
            addQuestionBlock(editQuestionsContainer, editQuestionCounter);
        });

        /**
         * Handles removing a question block from any container.
         * @param {HTMLElement} container - The container where the click originated.
         */
        function handleRemoveQuestion(container, e) {
            if (e.target.classList.contains('remove-question-btn')) {
                const questionCard = e.target.closest('.mcq-question-card');
                if (questionCard) {
                    questionCard.remove();
                    updateQuestionNumbers(container);
                    updateRemoveButtonsVisibility(container);
                }
            }
        }

        questionsContainer.addEventListener('click', (e) => handleRemoveQuestion(questionsContainer, e));
        editQuestionsContainer.addEventListener('click', (e) => handleRemoveQuestion(editQuestionsContainer, e));

        /**
         * Updates question numbers after removal for a specific container.
         * @param {HTMLElement} container - The container whose questions need re-numbering.
         */
        function updateQuestionNumbers(container) {
            let currentCounter = 0;
            container.querySelectorAll('.mcq-question-card').forEach((card, index) => {
                card.dataset.questionIndex = index;
                card.querySelector('label').textContent = `Question ${index + 1}`;
                card.querySelectorAll('input[type="radio"]').forEach(radio => {
                    radio.name = `correct-${index}`;
                });
                currentCounter = index;
            });
            // Update the correct counter based on the container
            if (container.id === 'questionsContainer') {
                questionCounter = currentCounter;
            } else if (container.id === 'editQuestionsContainer') {
                editQuestionCounter = currentCounter;
            }
        }

        /**
         * Shows/hides remove buttons based on number of questions in a specific container.
         * @param {HTMLElement} container - The container to check for remove buttons.
         */
        function updateRemoveButtonsVisibility(container) {
            const removeButtons = container.querySelectorAll('.remove-question-btn');
            if (removeButtons.length <= 1) {
                removeButtons.forEach(btn => btn.classList.add('hidden'));
            } else {
                removeButtons.forEach(btn => btn.classList.remove('hidden'));
            }
        }
        // Initial call to hide remove button for the first question in create form
        updateRemoveButtonsVisibility(questionsContainer);

        /**
         * Extracts question data from a form container.
         * @param {HTMLElement} container - The container holding the question cards.
         * @returns {Array<Object>} An array of question objects.
         */
        function getQuestionsFromContainer(container) {
            const questions = [];
            let isValid = true;
            container.querySelectorAll('.mcq-question-card').forEach((card, index) => {
                const questionText = card.querySelector('.question-text').value.trim();
                const options = [];
                let correctAnswerIndex = null;

                if (!questionText) {
                    showCustomModal("Input Error", `Question ${index + 1} text cannot be empty.`);
                    isValid = false;
                    return;
                }

                // Collect all options first
                const optionInputs = card.querySelectorAll('.option-text');
                optionInputs.forEach((optionInput, optionIndex) => {
                    const optionValue = optionInput.value.trim();
                    const optionLetter = optionInput.dataset.option;

                    if (!optionValue) {
                        showCustomModal("Input Error", `Option ${optionLetter} for Question ${index + 1} cannot be empty.`);
                        isValid = false;
                        return;
                    }
                    options.push(optionValue); // Store just the text, not the letter object
                });

                if (options.length !== 4) {
                    showCustomModal("Input Error", `Question ${index + 1} must have 4 options.`);
                    isValid = false;
                    return;
                }

                // Find the correct answer index
                const correctRadio = card.querySelector('input[type="radio"]:checked');
                if (!correctRadio) {
                    showCustomModal("Input Error", `Please select a correct answer for Question ${index + 1}.`);
                    isValid = false;
                    return;
                }

                // Convert letter to 0-based index
                const correctLetter = correctRadio.value;
                correctAnswerIndex = correctLetter.charCodeAt(0) - 65; // A=0, B=1, C=2, D=3

                questions.push({
                    questionText,
                    options: options, // Array of strings
                    correctAnswerIndex: correctAnswerIndex // 0-based index
                });
            });
            return isValid ? questions : null;
        }

        /**
         * Handles creation of a new MCQ test.
         */
        createTestForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            showLoading();

            const testTitle = testTitleInput.value.trim();
            const testCategoryId = testCategorySelect.value;
            const testCategoryName = testCategorySelect.options[testCategorySelect.selectedIndex].textContent;

            if (!testTitle || !testCategoryId) {
                showCustomModal("Input Error", "Please fill in test title and select a category.");
                hideLoading();
                return;
            }

            const questions = getQuestionsFromContainer(questionsContainer);
            if (!questions) {
                hideLoading();
                return;
            }

            if (questions.length === 0) {
                showCustomModal("Input Error", "Please add at least one question to the test.");
                hideLoading();
                return;
            }

            try {
                const testsCollectionRef = collection(db, `artifacts/${appId}/public/data/tests`);
                await addDoc(testsCollectionRef, {
                    title: testTitle,
                    category: testCategoryName, // Use category name for student compatibility
                    questions: questions,
                    createdAt: new Date()
                });
                showCustomModal("Success", `Test "${testTitle}" created successfully!`);
                createTestForm.reset();
                // Reset questions container to initial state
                questionsContainer.innerHTML = '';
                addQuestionBlock(questionsContainer, 0); // Add back one empty question
                questionCounter = 0;
            } catch (error) {
                console.error("Error creating test:", error);
                showCustomModal("Error", "Failed to create test.");
            } finally {
                hideLoading();
            }
        });

        /**
         * Handles creation of a new study post.
         */
        createPostForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            showLoading();

            const postTitle = postTitleInput.value.trim();
            const postCategoryId = postCategorySelect.value;
            const postCategoryName = postCategorySelect.options[postCategorySelect.selectedIndex].textContent;
            const postDescription = postDescriptionInput.value.trim();
            const postLinksText = postLinksInput.value.trim();

            if (!postTitle || !postCategoryId || !postDescription) {
                showCustomModal("Input Error", "Please fill in post title, category, and description.");
                hideLoading();
                return;
            }

            // Parse links from textarea (one per line)
            const links = postLinksText ? postLinksText.split('\n').map(link => link.trim()).filter(link => link) : [];

            try {
                const postsCollectionRef = collection(db, `artifacts/${appId}/public/data/posts`);
                await addDoc(postsCollectionRef, {
                    title: postTitle,
                    category: postCategoryName, // Use category name for student compatibility
                    description: postDescription,
                    links: links,
                    createdAt: new Date()
                });
                showCustomModal("Success", `Post "${postTitle}" created successfully!`);
                createPostForm.reset();
            } catch (error) {
                console.error("Error creating post:", error);
                showCustomModal("Error", "Failed to create post.");
            } finally {
                hideLoading();
            }
        });

        /**
         * Renders tests in the manage tests table based on the selected filter.
         * @param {Array} testsToRender - Tests to display (can be allTests or filteredTests).
         */
        function renderTestsTable(testsToRender) {
            testsTableBody.innerHTML = '';
            const filterCategoryName = filterTestCategorySelect.value;
            const filteredTests = filterCategoryName ? testsToRender.filter(test => {
                const testCategory = test.category || test.categoryName;
                return testCategory === filterCategoryName;
            }) : testsToRender;

            if (filteredTests.length === 0) {
                testsTableBody.innerHTML = '<tr><td colspan="4" class="text-center text-gray-500">No tests found for the selected category.</td></tr>';
                return;
            }

                            filteredTests.forEach(test => {
                    const row = document.createElement('tr');
                    
                    // Handle both old and new category formats
                    let categoryDisplay = test.category || test.categoryName || 'N/A';
                    
                    row.innerHTML = `
                        <td>${test.title}</td>
                        <td>${categoryDisplay}</td>
                        <td>${test.questions ? test.questions.length : 0}</td>
                        <td>
                            <button class="btn-edit edit-test-btn" data-id="${test.id}">Edit</button>
                            <button class="btn-danger delete-test-btn ml-2" data-id="${test.id}">Delete</button>
                        </td>
                    `;
                    testsTableBody.appendChild(row);
                });

            // Add event listeners for edit and delete buttons
            document.querySelectorAll('.edit-test-btn').forEach(button => {
                button.addEventListener('click', (e) => {
                    const testId = e.target.dataset.id;
                    openEditTestModal(testId);
                });
            });

            document.querySelectorAll('.delete-test-btn').forEach(button => {
                button.addEventListener('click', async (e) => {
                    const testId = e.target.dataset.id;
                    const testTitle = e.target.closest('tr').querySelector('td:first-child').textContent;
                    const confirmDelete = await showCustomModal("Confirm Delete", `Are you sure you want to delete test "${testTitle}"? This cannot be undone.`, true);
                    if (confirmDelete) {
                        await deleteTest(testId);
                    }
                });
            });
        }

        /**
         * Deletes a test from Firestore.
         * @param {string} testId - The ID of the test to delete.
         */
        async function deleteTest(testId) {
            showLoading();
            try {
                const testDocRef = doc(db, `artifacts/${appId}/public/data/tests`, testId);
                await deleteDoc(testDocRef);
                showCustomModal("Success", "Test deleted successfully!");
            } catch (error) {
                console.error("Error deleting test:", error);
                showCustomModal("Error", "Failed to delete test.");
            } finally {
                hideLoading();
            }
        }

        // Event listener for test category filter
        filterTestCategorySelect.addEventListener('change', () => {
            renderTestsTable(allTests); // Re-render with current allTests data, applying filter
        });

        /**
         * Renders posts in the manage posts table based on the selected filter.
         * @param {Array} postsToRender - Posts to display.
         */
        function renderPostsTable(postsToRender) {
            postsTableBody.innerHTML = '';
            const filterCategory = filterPostCategorySelect.value;
            const filteredPosts = filterCategory ? postsToRender.filter(post => post.category === filterCategory) : postsToRender;

            if (filteredPosts.length === 0) {
                postsTableBody.innerHTML = '<tr><td colspan="6" class="text-center text-gray-500">No posts found for the selected category.</td></tr>';
                return;
            }

            filteredPosts.forEach(post => {
                const row = document.createElement('tr');
                const linksText = post.links && post.links.length > 0 ? post.links.join(', ') : 'No links';
                const createdAt = post.createdAt ? post.createdAt.toDate().toLocaleDateString() : 'N/A';
                
                row.innerHTML = `
                    <td>${post.title}</td>
                    <td>${post.category || 'Uncategorized'}</td>
                    <td>${post.description.substring(0, 100)}${post.description.length > 100 ? '...' : ''}</td>
                    <td>${linksText}</td>
                    <td>${createdAt}</td>
                    <td>
                        <button class="btn-edit edit-post-btn" data-id="${post.id}">Edit</button>
                        <button class="btn-danger delete-post-btn ml-2" data-id="${post.id}">Delete</button>
                    </td>
                `;
                postsTableBody.appendChild(row);
            });

            // Add event listeners for edit and delete buttons
            document.querySelectorAll('.edit-post-btn').forEach(button => {
                button.addEventListener('click', (e) => {
                    const postId = e.target.dataset.id;
                    openEditPostModal(postId);
                });
            });

            document.querySelectorAll('.delete-post-btn').forEach(button => {
                button.addEventListener('click', (e) => {
                    const postId = e.target.dataset.id;
                    deletePost(postId);
                });
            });
        }

        // Event listener for post category filter
        filterPostCategorySelect.addEventListener('change', () => {
            renderPostsTable(allPosts);
        });

        /**
         * Opens the edit test modal and populates it with test data.
         * @param {string} testId - The ID of the test to edit.
         */
        async function openEditTestModal(testId) {
            showLoading();
            try {
                const testDocRef = doc(db, `artifacts/${appId}/public/data/tests`, testId);
                const testDocSnap = await getDoc(testDocRef);

                if (testDocSnap.exists()) {
                    const testData = testDocSnap.data();
                    editTestIdInput.value = testId;
                    editTestTitleInput.value = testData.title;
                    
                    // Handle both old and new category formats
                    let categoryName = testData.category;
                    if (testData.categoryName) {
                        categoryName = testData.categoryName; // Use old format if exists
                    }
                    
                    // Find the category ID based on the category name
                    const categoryObj = testCategories.find(cat => cat.title === categoryName);
                    editTestCategorySelect.value = categoryObj ? categoryObj.id : '';

                    // Clear existing questions and populate with fetched data
                    editQuestionsContainer.innerHTML = '';
                    editQuestionCounter = -1; // Reset counter for edit modal
                    testData.questions.forEach((q, index) => {
                        editQuestionCounter = index;
                        
                        // Handle both old and new question formats
                        let questionData = {
                            questionText: q.questionText,
                            options: q.options,
                            correctAnswerIndex: q.correctAnswerIndex
                        };
                        
                        // Convert old format to new format if needed
                        if (q.options && q.options.length > 0 && typeof q.options[0] === 'object') {
                            // Old format: options with {letter, text} structure
                            questionData.options = q.options.map(opt => opt.text);
                            if (q.correctAnswer) {
                                // Convert letter to index
                                questionData.correctAnswerIndex = q.correctAnswer.charCodeAt(0) - 65;
                            }
                        }
                        
                        addQuestionBlock(editQuestionsContainer, index, questionData);
                    });
                    updateRemoveButtonsVisibility(editQuestionsContainer);

                    editTestModal.classList.remove('hidden');
                } else {
                    showCustomModal("Error", "Test not found for editing.");
                }
            } catch (error) {
                console.error("Error opening edit modal:", error);
                showCustomModal("Error", "Failed to load test data for editing.");
            } finally {
                hideLoading();
            }
        }

        /**
         * Handles saving changes to an MCQ test.
         */
        editTestForm.addEventListener('submit', async (e) => {

        /**
         * Opens the edit post modal and populates it with post data.
         * @param {string} postId - The ID of the post to edit.
         */
        async function openEditPostModal(postId) {
            showLoading();
            try {
                const postDocRef = doc(db, `artifacts/${appId}/public/data/posts`, postId);
                const postDocSnap = await getDoc(postDocRef);

                if (postDocSnap.exists()) {
                    const postData = postDocSnap.data();
                    editPostIdInput.value = postId;
                    editPostTitleInput.value = postData.title;
                    
                    // Find the category ID based on the category name
                    const categoryObj = postCategories.find(cat => cat.title === postData.category);
                    editPostCategorySelect.value = categoryObj ? categoryObj.id : '';
                    
                    editPostDescriptionInput.value = postData.description;
                    editPostLinksInput.value = postData.links ? postData.links.join('\n') : '';

                    editPostModal.classList.remove('hidden');
                } else {
                    showCustomModal("Error", "Post not found for editing.");
                }
            } catch (error) {
                console.error("Error opening edit post modal:", error);
                showCustomModal("Error", "Failed to load post data for editing.");
            } finally {
                hideLoading();
            }
        }

        /**
         * Handles saving changes to a study post.
         */
        editPostForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            showLoading();

            const postId = editPostIdInput.value;
            const postTitle = editPostTitleInput.value.trim();
            const postCategoryId = editPostCategorySelect.value;
            const postCategoryName = editPostCategorySelect.options[editPostCategorySelect.selectedIndex].textContent;
            const postDescription = editPostDescriptionInput.value.trim();
            const postLinksText = editPostLinksInput.value.trim();

            if (!postTitle || !postCategoryId || !postDescription) {
                showCustomModal("Input Error", "Please fill in post title, category, and description.");
                hideLoading();
                return;
            }

            // Parse links from textarea (one per line)
            const links = postLinksText ? postLinksText.split('\n').map(link => link.trim()).filter(link => link) : [];

            try {
                const postDocRef = doc(db, `artifacts/${appId}/public/data/posts`, postId);
                await updateDoc(postDocRef, {
                    title: postTitle,
                    category: postCategoryName, // Use category name for student compatibility
                    description: postDescription,
                    links: links,
                    updatedAt: new Date()
                });
                showCustomModal("Success", `Post "${postTitle}" updated successfully!`);
                editPostModal.classList.add('hidden');
            } catch (error) {
                console.error("Error updating post:", error);
                showCustomModal("Error", "Failed to update post.");
            } finally {
                hideLoading();
            }
        });

        /**
         * Handles deletion of a study post.
         * @param {string} postId - The ID of the post to delete.
         */
        async function deletePost(postId) {
            const confirmed = await showCustomModal(
                "Confirm Deletion", 
                "Are you sure you want to delete this post? This action cannot be undone.", 
                true
            );
            if (!confirmed) return;

            showLoading();
            try {
                const postDocRef = doc(db, `artifacts/${appId}/public/data/posts`, postId);
                await deleteDoc(postDocRef);
                showCustomModal("Success", "Post deleted successfully!");
            } catch (error) {
                console.error("Error deleting post:", error);
                showCustomModal("Error", "Failed to delete post.");
            } finally {
                hideLoading();
            }
        }

        // Event listeners for edit post modal
        cancelEditPostBtn.addEventListener('click', () => {
            editPostModal.classList.add('hidden');
        });
            e.preventDefault();
            showLoading();

            const testId = editTestIdInput.value;
            const testTitle = editTestTitleInput.value.trim();
            const testCategoryId = editTestCategorySelect.value;
            const testCategoryName = editTestCategorySelect.options[editTestCategorySelect.selectedIndex].textContent;

            if (!testTitle || !testCategoryId) {
                showCustomModal("Input Error", "Please fill in test title and select a category.");
                hideLoading();
                return;
            }

            const questions = getQuestionsFromContainer(editQuestionsContainer);
            if (!questions) {
                hideLoading();
                return;
            }

            if (questions.length === 0) {
                showCustomModal("Input Error", "Please add at least one question to the test.");
                hideLoading();
                return;
            }

            try {
                const testDocRef = doc(db, `artifacts/${appId}/public/data/tests`, testId);
                await updateDoc(testDocRef, {
                    title: testTitle,
                    category: testCategoryName, // Use category name for student compatibility
                    questions: questions,
                    updatedAt: new Date() // Add an update timestamp
                });
                showCustomModal("Success", `Test "${testTitle}" updated successfully!`);
                editTestModal.classList.add('hidden'); // Close modal
            } catch (error) {
                console.error("Error updating test:", error);
                showCustomModal("Error", "Failed to update test.");
            } finally {
                hideLoading();
            }
        });

        // Cancel button for Edit Test Modal
        cancelEditTestBtn.addEventListener('click', () => {
            editTestModal.classList.add('hidden');
        });

        /**
         * Renders student users in the manage users table.
         * @param {Array} students - Array of student user objects.
         */
        function renderUsersTable(students) {
            usersTableBody.innerHTML = '';
            if (students.length === 0) {
                usersTableBody.innerHTML = '<tr><td colspan="6" class="text-center text-gray-500 py-8">No student users found. Students will appear here once they sign up through the student portal.</td></tr>';
                return;
            }
            students.forEach(student => {
                const row = document.createElement('tr');
                const registrationDate = student.createdAt ? new Date(student.createdAt.toDate ? student.createdAt.toDate() : student.createdAt).toLocaleDateString() : 'N/A';
                row.innerHTML = `
                    <td>${student.name || 'N/A'}</td>
                    <td>${student.email || 'N/A'}</td>
                    <td>${student.phoneNumber || 'N/A'}</td>
                    <td class="font-mono text-sm">${student.uid}</td>
                    <td>${registrationDate}</td>
                    <td>
                        <button class="btn-danger delete-user-btn" data-id="${student.uid}">Delete</button>
                    </td>
                `;
                usersTableBody.appendChild(row);
            });

            // Add event listeners for delete user buttons
            document.querySelectorAll('.delete-user-btn').forEach(button => {
                button.addEventListener('click', async (e) => {
                    const userIdToDelete = e.target.dataset.id;
                    const userName = e.target.closest('tr').querySelector('td:first-child').textContent;
                    const confirmDelete = await showCustomModal("Confirm Delete", `Are you sure you want to delete user "${userName}" (ID: ${userIdToDelete})? This cannot be undone.`, true);
                    if (confirmDelete) {
                        await deleteUser(userIdToDelete);
                    }
                });
            });
        }

        /**
         * Deletes a student user from Firestore.
         * @param {string} userId - The ID of the user to delete.
         */
        async function deleteUser(userId) {
            showLoading();
            try {
                const userDocRef = doc(db, `artifacts/${appId}/public/data/students`, userId);
                await deleteDoc(userDocRef);
                showCustomModal("Success", "Student user deleted successfully!");
            } catch (error) {
                console.error("Error deleting user:", error);
                showCustomModal("Error", "Failed to delete user.");
            } finally {
                hideLoading();
            }
        }



        /**
         * Migrates old test data format to new format for compatibility with student side.
         */
        async function migrateOldTestData() {
            const confirmMigration = await showCustomModal(
                "Data Migration", 
                "This will convert any existing tests from the old format to the new format for better compatibility. This action cannot be undone. Continue?", 
                true
            );
            
            if (!confirmMigration) return;
            
            showLoading();
            try {
                const testsCollectionRef = collection(db, `artifacts/${appId}/public/data/tests`);
                const querySnapshot = await getDocs(testsCollectionRef);
                let migratedCount = 0;
                
                for (const doc of querySnapshot.docs) {
                    const testData = doc.data();
                    let needsMigration = false;
                    let updatedData = { ...testData };
                    
                    // Check if test needs migration (has old format)
                    if (testData.categoryName && !testData.category) {
                        updatedData.category = testData.categoryName;
                        delete updatedData.categoryName;
                        needsMigration = true;
                    }
                    
                    if (testData.questions && testData.questions.length > 0) {
                        const updatedQuestions = testData.questions.map(q => {
                            let updatedQuestion = { ...q };
                            
                            // Check if options are in old format (objects with letter/text)
                            if (q.options && q.options.length > 0 && typeof q.options[0] === 'object') {
                                updatedQuestion.options = q.options.map(opt => opt.text);
                                needsMigration = true;
                            }
                            
                            // Check if correctAnswer is in letter format
                            if (q.correctAnswer && typeof q.correctAnswer === 'string') {
                                updatedQuestion.correctAnswerIndex = q.correctAnswer.charCodeAt(0) - 65;
                                delete updatedQuestion.correctAnswer;
                                needsMigration = true;
                            }
                            
                            return updatedQuestion;
                        });
                        
                        if (needsMigration) {
                            updatedData.questions = updatedQuestions;
                        }
                    }
                    
                    if (needsMigration) {
                        await updateDoc(doc.ref, updatedData);
                        migratedCount++;
                    }
                }
                
                if (migratedCount > 0) {
                    showCustomModal("Migration Complete", `Successfully migrated ${migratedCount} test(s) to the new format.`);
                } else {
                    showCustomModal("No Migration Needed", "All tests are already in the correct format.");
                }
                
            } catch (error) {
                console.error("Error during data migration:", error);
                showCustomModal("Migration Error", "Failed to migrate test data. Please try again.");
            } finally {
                hideLoading();
            }
        }

        // Initialize the app when the window loads
        window.onload = initializeFirebase;

        // Custom modal close button functionality
        modalCloseBtn.addEventListener('click', () => {
            customModal.classList.add('hidden');
        });

    </script>
</body>
</html>
