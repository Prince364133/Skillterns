<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Student Test Portal</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Font Awesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0f2f5;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 1rem;
        }
        .auth-card {
            background-color: #ffffff;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.05);
            padding: 2rem;
            max-width: 450px;
            margin: 2rem auto;
        }
        .form-toggle-btn {
            background-color: #e2e8f0;
            color: #4a5568;
            padding: 0.75rem 1.5rem;
            border-radius: 8px;
            font-weight: 600;
            transition: all 0.2s ease-in-out;
        }
        .form-toggle-btn.active {
            background-color: #4c51bf;
            color: #ffffff;
        }
        .input-field {
            width: 100%;
            padding: 0.75rem 1rem;
            border: 1px solid #cbd5e0;
            border-radius: 8px;
            font-size: 1rem;
            transition: border-color 0.2s ease-in-out;
        }
        .input-field:focus {
            outline: none;
            border-color: #4c51bf;
            box-shadow: 0 0 0 3px rgba(76, 81, 191, 0.2);
        }
        .btn-primary {
            background-color: #4c51bf;
            color: #ffffff;
            padding: 0.75rem 1.5rem;
            border-radius: 8px;
            font-weight: 600;
            transition: background-color 0.2s ease-in-out;
        }
        .btn-primary:hover {
            background-color: #363b90;
        }
        .btn-google {
            background-color: #db4437;
            color: #ffffff;
            padding: 0.75rem 1.5rem;
            border-radius: 8px;
            font-weight: 600;
            transition: background-color 0.2s ease-in-out;
        }
        .btn-google:hover {
            background-color: #c23321;
        }
        .nav-link {
            padding: 0.5rem 1rem;
            border-radius: 8px;
            transition: background-color 0.2s ease-in-out;
        }
        .nav-link:hover {
            background-color: #e2e8f0;
        }
        .card {
            background-color: #ffffff;
            border-radius: 12px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.04);
            padding: 1.5rem;
            transition: transform 0.2s ease-in-out;
        }
        .card:hover {
            transform: translateY(-5px);
        }
        /* Like button */
        .like-btn {
            background-color: #f3f4f6;
            color: #374151;
            padding: 0.5rem 0.75rem;
            border-radius: 8px;
            font-weight: 600;
            transition: background-color 0.2s ease-in-out;
        }
        .like-btn:hover { background-color: #e5e7eb; }
        .like-btn .fa-heart { transition: transform 0.2s ease-in-out; }
        .like-btn:hover .fa-heart { transform: scale(1.1); }
        .category-card, .test-card {
            cursor: pointer;
            border: 1px solid #e2e8f0;
        }
        .category-card:hover, .test-card:hover {
            border-color: #4c51bf;
        }
        /* Mobile responsive adjustments */
        @media (max-width: 768px) {
            .container {
                padding: 0.5rem;
            }
            .auth-card {
                margin: 1rem auto;
                padding: 1.5rem;
                max-width: 95%;
            }
            .card {
                padding: 1rem;
            }
            .btn-primary, .btn-google {
                padding: 0.6rem 1.2rem;
                font-size: 0.9rem;
            }
            .input-field {
                padding: 0.6rem 0.8rem;
                font-size: 0.9rem;
            }
            .grid {
                grid-template-columns: 1fr;
                gap: 1rem;
            }
            .grid.grid-cols-1.sm\\:grid-cols-2.lg\\:grid-cols-3 {
                grid-template-columns: 1fr;
            }
            .grid.grid-cols-1.md\\:grid-cols-2.lg\\:grid-cols-3 {
                grid-template-columns: 1fr;
            }
            .test-options {
                flex-direction: column;
                gap: 0.5rem;
            }
            .test-options button {
                width: 100%;
            }
            .question-container {
                padding: 1rem;
            }
            .option-button {
                padding: 0.8rem 1rem;
                font-size: 0.9rem;
            }
            .timer {
                font-size: 1.2rem;
                padding: 0.5rem 1rem;
            }
            .result-summary {
                padding: 1rem;
            }
            .result-summary h2 {
                font-size: 1.5rem;
            }
            .result-summary p {
                font-size: 0.9rem;
            }
            .option-button {
                padding: 0.6rem 0.8rem;
                font-size: 0.85rem;
                margin-bottom: 0.5rem;
            }
            .score-display {
                font-size: 2rem;
            }
            .message-box {
                width: 90%;
                left: 5%;
                transform: none;
                padding: 12px 20px;
                font-size: 0.9rem;
            }
            .loading-overlay {
                padding: 1rem;
            }
            /* Leaderboard mobile responsiveness */
            .min-w-full {
                min-width: auto;
            }
            table {
                font-size: 0.8rem;
            }
            th, td {
                padding: 0.5rem 0.25rem;
                word-break: break-word;
            }
            th {
                font-size: 0.7rem;
            }
            /* Make table scrollable horizontally on mobile */
            .card {
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
            }
            table {
                min-width: 500px;
            }
        }
        .option-button {
            background-color: #f7fafc;
            border: 1px solid #e2e8f0;
            color: #2d3748;
            padding: 0.75rem 1rem;
            border-radius: 8px;
            text-align: left;
            transition: all 0.2s ease-in-out;
        }
        .option-button:hover {
            background-color: #edf2f7;
            border-color: #a0aec0;
        }
        .option-button.selected {
            background-color: #c3dafe;
            border-color: #4c51bf;
            color: #2a4365;
        }
        .option-button.correct {
            background-color: #c6f6d5; /* Green for correct */
            border-color: #38a169;
            color: #276749;
        }
        .option-button.incorrect {
            background-color: #fed7d7; /* Red for incorrect */
            border-color: #e53e3e;
            color: #9b2c2c;
        }
        .score-display {
            font-size: 2.5rem;
            font-weight: 700;
            color: #4c51bf;
        }
        .message-box {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            background-color: #4c51bf;
            color: white;
            padding: 15px 30px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            z-index: 1000;
            opacity: 0;
            transition: opacity 0.3s ease-in-out;
        }
        .message-box.show {
            opacity: 1;
        }
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1001;
            display: none; /* Hidden by default */
        }
        .spinner {
            border: 8px solid #f3f3f3; /* Light grey */
            border-top: 8px solid #4c51bf; /* Blue */
            border-radius: 50%;
            width: 60px;
            height: 60px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen flex flex-col">
    <!-- Message Box -->
    <div id="messageBox" class="message-box"></div>

    <!-- Loading Overlay -->
    <div id="loadingOverlay" class="loading-overlay">
        <div class="spinner"></div>
    </div>

    <!-- Main Header/Navigation -->
    <header class="bg-white shadow-sm py-4">
        <nav class="container flex justify-between items-center">
            <h1 class="text-2xl font-bold text-gray-800">Skillyterns</h1>
            <div id="navLinks" class="hidden md:flex items-center space-x-4">
                <a href="#" id="homeNav" class="nav-link text-gray-700 font-medium">Home</a>
                <a href="#" id="postsNav" class="nav-link text-gray-700 font-medium">Posts</a>
                <a href="#" id="profileNav" class="nav-link text-gray-700 font-medium">Profile</a>
                <a href="#" id="testCategoriesNav" class="nav-link text-gray-700 font-medium">Test Categories</a>
                <a href="#" id="postCategoriesNav" class="nav-link text-gray-700 font-medium">Post Categories</a>
                <a href="#" id="allTestsNav" class="nav-link text-gray-700 font-medium">All Tests</a>
                <a href="#" id="logoutNav" class="nav-link text-red-600 font-medium"><i class="fas fa-sign-out-alt mr-2"></i>Logout</a>
            </div>
            <!-- Mobile Menu Button -->
            <button id="mobileMenuBtn" class="md:hidden text-gray-700 text-2xl">
                <i class="fas fa-bars"></i>
            </button>
        </nav>
        <!-- Mobile Navigation Menu -->
        <div id="mobileNavMenu" class="md:hidden bg-white shadow-md py-2 px-4 hidden">
            <a href="#" id="homeNavMobile" class="block nav-link text-gray-700 font-medium py-2">Home</a>
            <a href="#" id="postsNavMobile" class="block nav-link text-gray-700 font-medium py-2">Posts</a>
            <a href="#" id="profileNavMobile" class="block nav-link text-gray-700 font-medium py-2">Profile</a>
            <a href="#" id="testCategoriesNavMobile" class="block nav-link text-gray-700 font-medium py-2">Test Categories</a>
            <a href="#" id="postCategoriesNavMobile" class="block nav-link text-gray-700 font-medium py-2">Post Categories</a>
            <a href="#" id="allTestsNavMobile" class="block nav-link text-gray-700 font-medium py-2">All Tests</a>
            <a href="#" id="logoutNavMobile" class="block nav-link text-red-600 font-medium py-2"><i class="fas fa-sign-out-alt mr-2"></i>Logout</a>
        </div>
    </header>

    <main class="flex-grow container py-8">
        <!-- Authentication Section -->
        <section id="authSection" class="auth-card">
            <h2 class="text-3xl font-bold text-center mb-6 text-gray-800" id="authTitle">Login</h2>

            <div class="flex justify-center mb-6">
                <button id="loginToggle" class="form-toggle-btn active">Login</button>
                <button id="signupToggle" class="form-toggle-btn ml-2">Sign Up</button>
            </div>

            <form id="authForm" class="space-y-4">
                <div id="signupFields" class="space-y-4 hidden">
                    <div>
                        <label for="name" class="block text-sm font-medium text-gray-700 mb-1">Name</label>
                        <input type="text" id="name" class="input-field" placeholder="Your Name">
                    </div>
                    <div>
                        <label for="phone" class="block text-sm font-medium text-gray-700 mb-1">Phone (Optional)</label>
                        <input type="tel" id="phone" class="input-field" placeholder="e.g., +1234567890">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Email Verification Method</label>
                        <div class="grid grid-cols-1 gap-2 sm:grid-cols-2">
                            <label class="verification-method-card flex items-center p-3 border border-gray-200 rounded-lg cursor-pointer hover:bg-gray-50 transition-colors">
                                <input type="radio" name="verificationMethod" value="otp" class="mr-3 text-blue-600" checked>
                                <div>
                                    <span class="text-sm font-medium text-gray-900">6-Digit Code (OTP)</span>
                                    <p class="text-xs text-gray-500">Receive a code via email</p>
                                </div>
                            </label>
                            <label class="verification-method-card flex items-center p-3 border border-gray-200 rounded-lg cursor-pointer hover:bg-gray-50 transition-colors">
                                <input type="radio" name="verificationMethod" value="link" class="mr-3 text-blue-600">
                                <div>
                                    <span class="text-sm font-medium text-gray-900">Email Link</span>
                                    <p class="text-xs text-gray-500">Click a link in your email</p>
                                </div>
                            </label>
                        </div>
                        <p class="text-xs text-gray-500 mt-2">Choose your preferred verification method</p>
                    </div>
                </div>
                <div id="otpVerificationSection" class="space-y-4 hidden">
                    <div class="text-center">
                        <h3 class="text-lg font-semibold text-gray-800 mb-2">Verify Your Email</h3>
                        <p class="text-sm text-gray-600 mb-4">We've sent a verification code to <span id="otpEmailDisplay" class="font-mono text-blue-600"></span></p>
                    </div>
                    <div>
                        <label for="otpCode" class="block text-sm font-medium text-gray-700 mb-1">Verification Code</label>
                        <input type="text" id="otpCode" class="input-field text-center text-lg tracking-widest" placeholder="000000" maxlength="6" required>
                    </div>
                    <div class="flex justify-between items-center">
                        <button type="button" id="resendOtpBtn" class="text-sm text-blue-600 hover:text-blue-800">Resend Code</button>
                        <button type="button" id="backToSignupBtn" class="text-sm text-gray-600 hover:text-gray-800">← Back to Signup</button>
                    </div>
                </div>
                <div id="emailLinkVerificationSection" class="space-y-4 hidden">
                    <div class="text-center">
                        <h3 class="text-lg font-semibold text-gray-800 mb-2">Check Your Email</h3>
                        <p class="text-sm text-gray-600 mb-4">We've sent a verification link to <span id="linkEmailDisplay" class="font-mono text-blue-600"></span></p>
                        <div class="bg-blue-50 p-4 rounded-lg mb-4">
                            <i class="fas fa-envelope text-blue-600 text-2xl mb-2"></i>
                            <p class="text-sm text-blue-800">Click the link in your email to complete registration. This page will automatically refresh when verified.</p>
                        </div>
                    </div>
                    <div class="flex justify-between items-center">
                        <button type="button" id="resendEmailLinkBtn" class="text-sm text-blue-600 hover:text-blue-800">Resend Link</button>
                        <button type="button" id="backToSignupFromLinkBtn" class="text-sm text-gray-600 hover:text-gray-800">← Back to Signup</button>
                    </div>
                </div>
                <div id="emailPasswordSection">
                    <div>
                        <label for="email" class="block text-sm font-medium text-gray-700 mb-1">Email</label>
                        <input type="email" id="email" class="input-field" placeholder="your@example.com" required>
                    </div>
                    <div>
                        <label for="password" class="block text-sm font-medium text-gray-700 mb-1">Password</label>
                        <input type="password" id="password" class="input-field" placeholder="********" required>
                    </div>
                </div>
                <button type="submit" id="authSubmitBtn" class="w-full btn-primary">Login</button>
            </form>

            <div class="flex items-center my-6">
                <hr class="flex-grow border-gray-300">
                <span class="px-3 text-gray-500 text-sm">OR</span>
                <hr class="flex-grow border-gray-300">
            </div>

            <button id="googleSignInBtn" class="w-full btn-google flex items-center justify-center space-x-2">
                <i class="fab fa-google text-lg"></i>
                <span>Sign In with Google</span>
            </button>
        </section>

        <!-- Content Sections (Hidden until authenticated) -->
        <section id="contentSection" class="hidden">
            <!-- Welcome Message -->
            <div id="welcomeMessage" class="bg-blue-100 border-l-4 border-blue-500 text-blue-700 p-4 mb-8 rounded-lg" role="alert">
                <p class="font-bold text-xl">Welcome, <span id="userNameDisplay"></span>!</p>
                <p id="firstLoginMessage" class="text-sm mt-1 hidden">It's great to have you here. Let's start learning!</p>
            </div>

            <!-- Home Section: Recent Feed -->
            <div id="homeSection" class="mb-8">
                <h2 class="text-3xl font-bold text-gray-800 mb-6">Welcome to Skillyterns</h2>
                <!-- Recent Combined Feed -->
                <div class="mb-8">
                    <h3 class="text-2xl font-bold text-gray-800 mb-4">Recent Posts & Tests</h3>
                    <div id="recentFeedContainer" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6"></div>
                    <p id="noRecentMessage" class="text-gray-600 text-center mt-8 hidden">No recent items found. Please check back later!</p>
                </div>
            </div>

            <!-- Posts Section -->
            <div id="postsSection" class="hidden mb-8">
                <h2 class="text-3xl font-bold text-gray-800 mb-6">Study Posts</h2>
                <div class="mb-6">
                    <input type="text" id="postSearchInput" class="input-field" placeholder="Search posts by title...">
                </div>
                <div id="postsContainer" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6">
                    <!-- All posts will be loaded here dynamically -->
                </div>
                <p id="noPostsFoundMessage" class="text-gray-600 text-center mt-8 hidden">No posts found. Try adjusting your search!</p>
            </div>

            <!-- Profile Section -->
            <div id="profileSection" class="hidden mb-8">
                <h2 class="text-3xl font-bold text-gray-800 mb-6">Your Profile</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="card p-6">
                        <h3 class="text-xl font-semibold text-gray-800 mb-4">Account Info</h3>
                        <p class="text-gray-600"><span class="font-semibold">Name:</span> <span id="profileName"></span></p>
                        <p class="text-gray-600"><span class="font-semibold">Email:</span> <span id="profileEmail"></span></p>
                        <p class="text-gray-600"><span class="font-semibold">Phone:</span> <span id="profilePhone"></span></p>
                    </div>
                    <div class="card p-6">
                        <h3 class="text-xl font-semibold text-gray-800 mb-4">Performance</h3>
                        <p class="text-gray-600"><span class="font-semibold">Tests Taken:</span> <span id="profileTestsTaken">0</span></p>
                        <p class="text-gray-600"><span class="font-semibold">Total Marks:</span> <span id="profileTotalMarks">0</span></p>
                        <button id="viewMyRankBtn" class="btn-primary mt-4">View My Rank</button>
                        <p id="myRankDisplay" class="text-gray-700 mt-3"></p>
                    </div>
                </div>
                </div>

            <!-- Test Categories Section -->
            <div id="testCategoriesSection" class="hidden mb-8">
                <h2 class="text-3xl font-bold text-gray-800 mb-6">Test Categories</h2>
                <div id="testCategoriesContainer" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6"></div>
                <p id="noTestCategoriesMessage" class="text-gray-600 text-center mt-8 hidden">No test categories found.</p>
                    </div>

            <!-- Post Categories Section -->
            <div id="postCategoriesSection" class="hidden mb-8">
                <h2 class="text-3xl font-bold text-gray-800 mb-6">Post Categories</h2>
                <div id="postCategoriesContainer" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6"></div>
                    <p id="noPostCategoriesMessage" class="text-gray-600 text-center mt-8 hidden">No post categories found.</p>
            </div>

            <!-- All Tests Section -->
            <div id="allTestsSection" class="hidden mb-8">
                <h2 class="text-3xl font-bold text-gray-800 mb-6">All Available Tests</h2>
                <div class="mb-6">
                    <input type="text" id="testSearchInput" class="input-field" placeholder="Search tests by name...">
                </div>
                <div id="allTestsContainer" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6">
                    <!-- All tests will be loaded here dynamically -->
                </div>
                <p id="noTestsMessage" class="text-gray-600 text-center mt-8 hidden">No tests found. Try adjusting your search!</p>
            </div>

            <!-- Test Page Section -->
            <div id="testPageSection" class="hidden">
                <h2 id="testTitle" class="text-3xl font-bold text-gray-800 mb-6"></h2>
                <div id="questionsContainer" class="space-y-6">
                    <!-- Questions will be loaded here dynamically -->
                </div>
                <button id="submitTestBtn" class="mt-8 w-full btn-primary hidden">Submit Test</button>
            </div>

            <!-- Test Results Section -->
            <div id="resultsSection" class="hidden">
                <h2 class="text-3xl font-bold text-gray-800 mb-6">Your Test Results</h2>
                <div class="bg-white card p-6 text-center mb-6">
                    <p class="text-gray-600 text-lg mb-2">Your Score:</p>
                    <p id="finalScore" class="score-display"></p>
                    <p id="scoreOutOf" class="text-gray-500 text-lg"></p>
                </div>

                <h3 class="text-2xl font-bold text-gray-800 mb-4">Detailed Review</h3>
                <div id="reviewContainer" class="space-y-6">
                    <!-- Question review will be loaded here -->
                </div>

                <div class="mt-8 flex flex-col sm:flex-row justify-center space-y-4 sm:space-y-0 sm:space-x-4">
                    <button id="viewLeaderboardBtn" class="btn-primary">View Leaderboard</button>
                    <button id="takeAnotherTestBtn" class="btn-primary">Take Another Test</button>
                </div>
            </div>

            <!-- Leaderboard Section -->
            <div id="leaderboardSection" class="hidden">
                <h2 class="text-3xl font-bold text-gray-800 mb-6">Leaderboard for <span id="leaderboardTestTitle"></span></h2>
                <div class="bg-white card p-6">
                    <div class="overflow-x-auto">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Rank</th>
                                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">User</th>
                                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Score</th>
                                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Submitted At</th>
                                </tr>
                            </thead>
                            <tbody id="leaderboardBody" class="bg-white divide-y divide-gray-200">
                                <!-- Leaderboard data will be loaded here -->
                            </tbody>
                        </table>
                    </div>
                    <p id="noLeaderboardData" class="text-gray-600 text-center mt-4 hidden">No results found for this test yet.</p>
                </div>
                <button id="backToResultsBtn" class="mt-8 btn-primary">Back to Results</button>
            </div>

            <!-- Overall Leaderboard (My Rank) Section -->
            <div id="overallLeaderboardSection" class="hidden">
                <h2 class="text-3xl font-bold text-gray-800 mb-2">Overall Leaderboard</h2>
                <p id="myOverallRankBanner" class="text-gray-700 mb-6"></p>
                <div class="bg-white card p-6">
                    <div class="overflow-x-auto">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Rank</th>
                                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Name</th>
                                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Email</th>
                                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Total Points</th>
                                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Tests Count</th>
                                </tr>
                            </thead>
                            <tbody id="overallLeaderboardBody" class="bg-white divide-y divide-gray-200"></tbody>
                        </table>
                    </div>
                </div>
                <div class="mt-6">
                    <button id="backToProfileBtn" class="btn-primary">Back to Profile</button>
                </div>
            </div>

            <!-- Past Results Section -->
            <div id="pastResultsSection" class="hidden">
                <h2 class="text-3xl font-bold text-gray-800 mb-6">Your Past Test Results</h2>
                <div class="bg-white card p-6">
                    <div class="overflow-x-auto">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Test</th>
                                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Score</th>
                                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Submitted At</th>
                                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Review</th>
                                </tr>
                            </thead>
                            <tbody id="pastResultsBody" class="bg-white divide-y divide-gray-200">
                                <!-- Past results data will be loaded here -->
                            </tbody>
                        </table>
                    </div>
                    <p id="noPastResultsData" class="text-gray-600 text-center mt-4 hidden">You haven't completed any tests yet.</p>
                </div>
            </div>
        </section>
    </main>

    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import {
            getAuth,
            signInAnonymously,
            signInWithCustomToken,
            onAuthStateChanged,
            createUserWithEmailAndPassword,
            signInWithEmailAndPassword,
            sendSignInLinkToEmail,
            isSignInWithEmailLink,
            signInWithEmailLink,
            GoogleAuthProvider,
            signInWithPopup,
            signOut
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import {
            getFirestore,
            doc,
            getDoc,
            setDoc,
            addDoc,
            collection,
            query,
            where,
            getDocs,
            serverTimestamp,
            orderBy,
            deleteDoc
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Firebase Configuration (from user prompt)
        const firebaseConfig = {
            apiKey: "AIzaSyAGPyk54-zJUE6iV3872XKLIq9OW3KCM6o",
            authDomain: "skillyterns.firebaseapp.com",
            databaseURL: "https://skillyterns-default-rtdb.firebaseio.com",
            projectId: "skillyterns",
            storageBucket: "skillyterns.firebasestorage.app",
            messagingSenderId: "1034584532277",
            appId: "1:1034584532277:web:fb79e2d96ee5127421d87c",
            measurementId: "G-5G2GCWYEPL"
        };

        // Canvas environment variables
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        let currentUser = null;
        let currentTest = null;
        let userAnswers = [];
        let currentTestId = null; // To store the ID of the test being taken
        let currentTestTitle = ''; // To store the title of the test being taken
        
        // Authentication and verification state
        let isLoginMode = true;
        let isOtpMode = false;
        let isEmailLinkMode = false;
        let pendingSignupData = null;
        let generatedOtp = null;
        let otpAttempts = 0;
        let emailLinkCheckInterval = null;
        const maxOtpAttempts = 3;
        
        // Performance optimization: Data caching
        let cachedData = {
            posts: null,
            postCategories: null,
            testCategories: null,
            tests: null,
            lastFetchTime: {
                posts: 0,
                postCategories: 0,
                testCategories: 0,
                tests: 0
            }
        };
        const CACHE_DURATION = 5 * 60 * 1000; // 5 minutes cache

        // Performance optimization functions
        function isCacheValid(dataType) {
            return cachedData[dataType] && 
                   (Date.now() - cachedData.lastFetchTime[dataType]) < CACHE_DURATION;
        }

        function setCachedData(dataType, data) {
            cachedData[dataType] = data;
            cachedData.lastFetchTime[dataType] = Date.now();
        }

        // Debounce function for search inputs
        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }

        // Lazy loading with Intersection Observer
        function setupLazyLoading() {
            if ('IntersectionObserver' in window) {
                const imageObserver = new IntersectionObserver((entries, observer) => {
                    entries.forEach(entry => {
                        if (entry.isIntersecting) {
                            const img = entry.target;
                            img.src = img.dataset.src;
                            img.classList.remove('lazy');
                            imageObserver.unobserve(img);
                        }
                    });
                });

                document.querySelectorAll('img[data-src]').forEach(img => {
                    imageObserver.observe(img);
                });
            }
        }

        // --- DOM Elements ---
        const authSection = document.getElementById('authSection');
        const contentSection = document.getElementById('contentSection');
        const loginToggle = document.getElementById('loginToggle');
        const signupToggle = document.getElementById('signupToggle');
        const authTitle = document.getElementById('authTitle');
        const signupFields = document.getElementById('signupFields');
        const otpVerificationSection = document.getElementById('otpVerificationSection');
        const emailLinkVerificationSection = document.getElementById('emailLinkVerificationSection');
        const emailPasswordSection = document.getElementById('emailPasswordSection');
        const otpEmailDisplay = document.getElementById('otpEmailDisplay');
        const linkEmailDisplay = document.getElementById('linkEmailDisplay');
        const otpCodeInput = document.getElementById('otpCode');
        const resendOtpBtn = document.getElementById('resendOtpBtn');
        const resendEmailLinkBtn = document.getElementById('resendEmailLinkBtn');
        const backToSignupBtn = document.getElementById('backToSignupBtn');
        const backToSignupFromLinkBtn = document.getElementById('backToSignupFromLinkBtn');
        const authForm = document.getElementById('authForm');
        const emailInput = document.getElementById('email');
        const passwordInput = document.getElementById('password');
        const nameInput = document.getElementById('name');
        const phoneInput = document.getElementById('phone');
        const authSubmitBtn = document.getElementById('authSubmitBtn');
        const googleSignInBtn = document.getElementById('googleSignInBtn');

        const navLinks = document.getElementById('navLinks');
        const mobileMenuBtn = document.getElementById('mobileMenuBtn');
        const mobileNavMenu = document.getElementById('mobileNavMenu');
        const homeNav = document.getElementById('homeNav');
        const postsNav = document.getElementById('postsNav');
        const profileNav = document.getElementById('profileNav');
        const testCategoriesNav = document.getElementById('testCategoriesNav');
        const postCategoriesNav = document.getElementById('postCategoriesNav');
        const allTestsNav = document.getElementById('allTestsNav');
        const logoutNav = document.getElementById('logoutNav');
        const homeNavMobile = document.getElementById('homeNavMobile');
        const postsNavMobile = document.getElementById('postsNavMobile');
        const profileNavMobile = document.getElementById('profileNavMobile');
        const testCategoriesNavMobile = document.getElementById('testCategoriesNavMobile');
        const postCategoriesNavMobile = document.getElementById('postCategoriesNavMobile');
        const allTestsNavMobile = document.getElementById('allTestsNavMobile');
        const logoutNavMobile = document.getElementById('logoutNavMobile');

        const welcomeMessage = document.getElementById('welcomeMessage');
        const userNameDisplay = document.getElementById('userNameDisplay');
        const firstLoginMessage = document.getElementById('firstLoginMessage');

        const homeSection = document.getElementById('homeSection');
        const recentFeedContainer = document.getElementById('recentFeedContainer');
        const noRecentMessage = document.getElementById('noRecentMessage');
        const profileSection = document.getElementById('profileSection');
        const profileName = document.getElementById('profileName');
        const profileEmail = document.getElementById('profileEmail');
        const profilePhone = document.getElementById('profilePhone');
        const profileTestsTaken = document.getElementById('profileTestsTaken');
        const profileTotalMarks = document.getElementById('profileTotalMarks');
        const viewMyRankBtn = document.getElementById('viewMyRankBtn');
        const myRankDisplay = document.getElementById('myRankDisplay');

        const postsSection = document.getElementById('postsSection');
        const postSearchInput = document.getElementById('postSearchInput');
        const postsContainer = document.getElementById('postsContainer');
        const noPostsFoundMessage = document.getElementById('noPostsFoundMessage');

        const testCategoriesSection = document.getElementById('testCategoriesSection');
        const postCategoriesSection = document.getElementById('postCategoriesSection');
        const testCategoriesContainer = document.getElementById('testCategoriesContainer');
        const postCategoriesContainer = document.getElementById('postCategoriesContainer');
        const noTestCategoriesMessage = document.getElementById('noTestCategoriesMessage');
        const noPostCategoriesMessage = document.getElementById('noPostCategoriesMessage');
        const overallLeaderboardSection = document.getElementById('overallLeaderboardSection');
        const overallLeaderboardBody = document.getElementById('overallLeaderboardBody');
        const myOverallRankBanner = document.getElementById('myOverallRankBanner');
        const backToProfileBtn = document.getElementById('backToProfileBtn');

        const allTestsSection = document.getElementById('allTestsSection');
        const testSearchInput = document.getElementById('testSearchInput');
        const allTestsContainer = document.getElementById('allTestsContainer');
        const noTestsMessage = document.getElementById('noTestsMessage');

        const testPageSection = document.getElementById('testPageSection');
        const testTitleElement = document.getElementById('testTitle');
        const questionsContainer = document.getElementById('questionsContainer');
        const submitTestBtn = document.getElementById('submitTestBtn');

        const resultsSection = document.getElementById('resultsSection');
        const finalScore = document.getElementById('finalScore');
        const scoreOutOf = document.getElementById('scoreOutOf');
        const reviewContainer = document.getElementById('reviewContainer');
        const viewLeaderboardBtn = document.getElementById('viewLeaderboardBtn');
        const takeAnotherTestBtn = document.getElementById('takeAnotherTestBtn');

        const leaderboardSection = document.getElementById('leaderboardSection');
        const leaderboardTestTitle = document.getElementById('leaderboardTestTitle');
        const leaderboardBody = document.getElementById('leaderboardBody');
        const noLeaderboardData = document.getElementById('noLeaderboardData');
        const backToResultsBtn = document.getElementById('backToResultsBtn');

        const pastResultsSection = document.getElementById('pastResultsSection');
        const pastResultsBody = document.getElementById('pastResultsBody');
        const noPastResultsData = document.getElementById('noPastResultsData');

        const messageBox = document.getElementById('messageBox');
        const loadingOverlay = document.getElementById('loadingOverlay');

        // --- Utility Functions ---
        function showMessage(message, duration = 3000) {
            messageBox.textContent = message;
            messageBox.classList.add('show');
            setTimeout(() => {
                messageBox.classList.remove('show');
            }, duration);
        }

        function showLoading() {
            loadingOverlay.style.display = 'flex';
        }

        function hideLoading() {
            loadingOverlay.style.display = 'none';
        }

        function hideAllSections() {
            homeSection.classList.add('hidden');
            postsSection.classList.add('hidden');
            testCategoriesSection.classList.add('hidden');
            postCategoriesSection.classList.add('hidden');
            allTestsSection.classList.add('hidden');
            testPageSection.classList.add('hidden');
            resultsSection.classList.add('hidden');
            leaderboardSection.classList.add('hidden');
            pastResultsSection.classList.add('hidden');
        }

        function showSection(sectionElement) {
            hideAllSections();
            sectionElement.classList.remove('hidden');
        }

        // --- Authentication Logic ---
        
        // Handle verification method selection styling
        document.addEventListener('DOMContentLoaded', function() {
            const verificationCards = document.querySelectorAll('.verification-method-card');
            const radioInputs = document.querySelectorAll('input[name="verificationMethod"]');
            
            function updateCardStyles() {
                verificationCards.forEach(card => {
                    const radio = card.querySelector('input[type="radio"]');
                    if (radio.checked) {
                        card.classList.add('border-blue-500', 'bg-blue-50');
                        card.classList.remove('border-gray-200');
                    } else {
                        card.classList.remove('border-blue-500', 'bg-blue-50');
                        card.classList.add('border-gray-200');
                    }
                });
            }
            
            // Initial styling
            updateCardStyles();
            
            // Update styling when selection changes
            radioInputs.forEach(radio => {
                radio.addEventListener('change', updateCardStyles);
            });
        });
        
        function resetAuthForm() {
            isOtpMode = false;
            isEmailLinkMode = false;
            pendingSignupData = null;
            generatedOtp = null;
            otpAttempts = 0;
            
            // Clear any email link checking interval
            if (emailLinkCheckInterval) {
                clearInterval(emailLinkCheckInterval);
                emailLinkCheckInterval = null;
            }
            
            // Hide all verification sections
            otpVerificationSection.classList.add('hidden');
            emailLinkVerificationSection.classList.add('hidden');
            emailPasswordSection.classList.remove('hidden');
            signupFields.classList.add('hidden');
            
            // Show submit button and reset
            authSubmitBtn.style.display = 'block';
            authSubmitBtn.textContent = 'Login';
            
            // Clear inputs
            otpCodeInput.value = '';
            
            // Reset verification method to OTP
            const otpRadio = document.querySelector('input[name="verificationMethod"][value="otp"]');
            if (otpRadio) otpRadio.checked = true;
        }

        loginToggle.addEventListener('click', () => {
            resetAuthForm();
            isLoginMode = true;
            authTitle.textContent = 'Login';
            authSubmitBtn.textContent = 'Login';
            loginToggle.classList.add('active');
            signupToggle.classList.remove('active');
        });

        signupToggle.addEventListener('click', () => {
            resetAuthForm();
            isLoginMode = false;
            authTitle.textContent = 'Sign Up';
            signupFields.classList.remove('hidden');
            authSubmitBtn.textContent = 'Sign Up';
            signupToggle.classList.add('active');
            loginToggle.classList.remove('active');
        });

        backToSignupBtn.addEventListener('click', () => {
            resetAuthForm();
            isLoginMode = false;
            authTitle.textContent = 'Sign Up';
            signupFields.classList.remove('hidden');
            authSubmitBtn.textContent = 'Sign Up';
        });

        backToSignupFromLinkBtn.addEventListener('click', () => {
            resetAuthForm();
            isLoginMode = false;
            authTitle.textContent = 'Sign Up';
            signupFields.classList.remove('hidden');
            authSubmitBtn.textContent = 'Sign Up';
        });

        // Generate 6-digit OTP
        function generateOTP() {
            return Math.floor(100000 + Math.random() * 900000).toString();
        }

        // Send OTP via email (simulated - in production use a real email service)
        async function sendOTPEmail(email, otp) {
            // In a real application, you would use a service like SendGrid, Nodemailer, etc.
            // For this demo, we'll simulate sending and store the OTP temporarily
            console.log(`🔐 OTP for ${email}: ${otp} (Check browser console for development)`);
            
            // Simulate API call delay
            await new Promise(resolve => setTimeout(resolve, 1000));
            
            // Store OTP in localStorage temporarily (in production, use server-side storage)
            localStorage.setItem(`otp_${email}`, JSON.stringify({
                otp: otp,
                timestamp: Date.now(),
                attempts: 0
            }));
            
            showMessage(`Verification code sent to ${email}. Check your email and enter the 6-digit code.`);
            return true;
        }

        // Verify OTP
        function verifyOTP(email, inputOtp) {
            const storedData = localStorage.getItem(`otp_${email}`);
            if (!storedData) {
                return { valid: false, error: 'No OTP found. Please request a new one.' };
            }

            const { otp, timestamp, attempts } = JSON.parse(storedData);
            
            // Check if OTP is expired (5 minutes)
            if (Date.now() - timestamp > 300000) {
                localStorage.removeItem(`otp_${email}`);
                return { valid: false, error: 'OTP has expired. Please request a new one.' };
            }

            // Check attempt limit
            if (attempts >= maxOtpAttempts) {
                localStorage.removeItem(`otp_${email}`);
                return { valid: false, error: 'Too many failed attempts. Please request a new OTP.' };
            }

            if (otp === inputOtp) {
                localStorage.removeItem(`otp_${email}`);
                return { valid: true };
            } else {
                // Increment attempts
                const updatedData = { otp, timestamp, attempts: attempts + 1 };
                localStorage.setItem(`otp_${email}`, JSON.stringify(updatedData));
                return { valid: false, error: `Invalid OTP. ${maxOtpAttempts - attempts - 1} attempts remaining.` };
            }
        }

        resendOtpBtn.addEventListener('click', async () => {
            if (pendingSignupData) {
                showLoading();
                try {
                    generatedOtp = generateOTP();
                    await sendOTPEmail(pendingSignupData.email, generatedOtp);
                    otpAttempts = 0;
                } catch (error) {
                    showMessage('Failed to resend OTP. Please try again.');
                } finally {
                    hideLoading();
                }
            }
        });

        // Send email link for verification
        async function sendVerificationEmailLink(email, userData) {
            const actionCodeSettings = {
                url: window.location.origin + '/skillyterns/student.html?mode=verify&email=' + encodeURIComponent(email),
                handleCodeInApp: true,
            };

            try {
                await sendSignInLinkToEmail(auth, email, actionCodeSettings);
                
                // Store user data temporarily for completion after email verification
                localStorage.setItem('emailLinkUserData', JSON.stringify(userData));
                localStorage.setItem('emailForSignIn', email);
                
                console.log(`📧 Email verification link sent to: ${email}`);
                showMessage(`Verification link sent to ${email}. Check your email and click the link.`);
                return true;
            } catch (error) {
                console.error('Error sending email link:', error);
                throw error;
            }
        }

        // Check email link verification status
        function startEmailLinkVerificationCheck() {
            emailLinkCheckInterval = setInterval(async () => {
                if (isSignInWithEmailLink(auth, window.location.href)) {
                    try {
                        const email = localStorage.getItem('emailForSignIn');
                        const userData = JSON.parse(localStorage.getItem('emailLinkUserData') || '{}');
                        
                        if (email && userData.email === email) {
                            await completeEmailLinkSignup(email, userData);
                        }
                    } catch (error) {
                        console.error('Error during email link verification:', error);
                    }
                } else {
                    // Check if user clicked a link in another tab/window
                    try {
                        const email = localStorage.getItem('emailForSignIn');
                        if (email && auth.currentUser && auth.currentUser.email === email) {
                            clearInterval(emailLinkCheckInterval);
                            emailLinkCheckInterval = null;
                            showMessage('Email verified successfully! Welcome!');
                            resetAuthForm();
                        }
                    } catch (error) {
                        // Continue checking
                    }
                }
            }, 2000); // Check every 2 seconds
        }

        // Complete email link signup process
        async function completeEmailLinkSignup(email, userData) {
            try {
                const result = await signInWithEmailLink(auth, email, window.location.href);
                const user = result.user;

                // Save to users collection for student portal
                await setDoc(doc(db, 'artifacts', appId, 'users', user.uid), {
                    uid: user.uid,
                    name: userData.name || 'Student',
                    phone: userData.phone || '',
                    email: email,
                    emailVerified: true
                });
                
                // Also save to students collection for admin panel
                await setDoc(doc(db, 'artifacts', appId, 'public/data/students', user.uid), {
                    uid: user.uid,
                    name: userData.name || 'Student',
                    phoneNumber: userData.phone || '',
                    email: email,
                    emailVerified: true,
                    createdAt: new Date()
                });

                // Clean up stored data
                localStorage.removeItem('emailLinkUserData');
                localStorage.removeItem('emailForSignIn');
                
                clearInterval(emailLinkCheckInterval);
                emailLinkCheckInterval = null;
                
                showMessage('Email verified! Account created successfully! Welcome!');
                resetAuthForm();
                
                // Clean up URL
                window.history.replaceState({}, document.title, window.location.pathname);
                
            } catch (error) {
                console.error('Error completing email link signup:', error);
                showMessage('Failed to complete email verification. Please try again.');
            }
        }

        resendEmailLinkBtn.addEventListener('click', async () => {
            if (pendingSignupData) {
                showLoading();
                try {
                    await sendVerificationEmailLink(pendingSignupData.email, pendingSignupData);
                } catch (error) {
                    showMessage('Failed to resend email link. Please try again.');
                } finally {
                    hideLoading();
                }
            }
        });

        authForm.addEventListener('submit', async (e) => {
            e.preventDefault();

            if (isOtpMode) {
                // Handle OTP verification
                const otpCode = otpCodeInput.value.trim();
                if (!otpCode || otpCode.length !== 6) {
                    showMessage('Please enter a valid 6-digit verification code.');
                    return;
                }

                showLoading();
                try {
                    const verificationResult = verifyOTP(pendingSignupData.email, otpCode);
                    if (verificationResult.valid) {
                        // OTP verified, proceed with Firebase signup
                        const userCredential = await createUserWithEmailAndPassword(auth, pendingSignupData.email, pendingSignupData.password);
                        const user = userCredential.user;
                        
                        // Save to users collection for student portal
                        await setDoc(doc(db, 'artifacts', appId, 'users', user.uid), {
                            uid: user.uid,
                            name: pendingSignupData.name || 'Student',
                            phone: pendingSignupData.phone || '',
                            email: pendingSignupData.email,
                            emailVerified: true
                        });
                        
                        // Also save to students collection for admin panel
                        await setDoc(doc(db, 'artifacts', appId, 'public/data/students', user.uid), {
                            uid: user.uid,
                            name: pendingSignupData.name || 'Student',
                            phoneNumber: pendingSignupData.phone || '',
                            email: pendingSignupData.email,
                            emailVerified: true,
                            createdAt: new Date()
                        });
                        
                        showMessage('Email verified! Account created successfully! Welcome!');
                        resetAuthForm();
                    } else {
                        showMessage(verificationResult.error);
                    }
                } catch (error) {
                    console.error('Error during signup:', error);
                    let errorMessage = 'Failed to create account. Please try again.';
                    if (error.code === 'auth/email-already-in-use') {
                        errorMessage = 'Email already in use. Try logging in or use a different email.';
                    }
                    showMessage(errorMessage);
                } finally {
                    hideLoading();
                }
                return;
            }

            // Handle initial login/signup
            const email = emailInput.value;
            const password = passwordInput.value;
            const name = nameInput.value;
            const phone = phoneInput.value;

            showLoading();
            try {
                if (isLoginMode) {
                    await signInWithEmailAndPassword(auth, email, password);
                    showMessage('Logged in successfully!');
                } else {
                    // Signup with verification
                    if (!name.trim()) {
                        showMessage('Please enter your name.');
                        hideLoading();
                        return;
                    }
                    
                    // Get selected verification method
                    const verificationMethod = document.querySelector('input[name="verificationMethod"]:checked')?.value || 'otp';
                    
                    // Store pending signup data
                    pendingSignupData = { email, password, name, phone };
                    
                    if (verificationMethod === 'otp') {
                        // OTP verification
                        generatedOtp = generateOTP();
                        await sendOTPEmail(email, generatedOtp);
                        
                        isOtpMode = true;
                        isEmailLinkMode = false;
                        
                        // Show OTP verification form
                        emailPasswordSection.classList.add('hidden');
                        signupFields.classList.add('hidden');
                        otpVerificationSection.classList.remove('hidden');
                        otpEmailDisplay.textContent = email;
                        authTitle.textContent = 'Email Verification - OTP';
                        authSubmitBtn.textContent = 'Verify Code';
                    } else {
                        // Email link verification
                        await sendVerificationEmailLink(email, pendingSignupData);
                        
                        isOtpMode = false;
                        isEmailLinkMode = true;
                        
                        // Show email link verification form
                        emailPasswordSection.classList.add('hidden');
                        signupFields.classList.add('hidden');
                        emailLinkVerificationSection.classList.remove('hidden');
                        linkEmailDisplay.textContent = email;
                        authTitle.textContent = 'Email Verification - Link';
                        authSubmitBtn.style.display = 'none'; // Hide submit button for email link
                        
                        // Start checking for email link verification
                        startEmailLinkVerificationCheck();
                    }
                }
            } catch (error) {
                console.error('Auth error:', error.code, error.message);
                let errorMessage = 'An error occurred. Please try again.';
                if (error.code === 'auth/email-already-in-use') {
                    errorMessage = 'Email already in use. Try logging in or use a different email.';
                } else if (error.code === 'auth/invalid-email') {
                    errorMessage = 'Invalid email address.';
                } else if (error.code === 'auth/weak-password') {
                    errorMessage = 'Password should be at least 6 characters.';
                } else if (error.code === 'auth/user-not-found' || error.code === 'auth/wrong-password') {
                    errorMessage = 'Invalid email or password.';
                } else if (error.code === 'auth/invalid-action-code') {
                    errorMessage = 'Invalid or expired verification link.';
                }
                showMessage(errorMessage);
            } finally {
                hideLoading();
            }
        });

        googleSignInBtn.addEventListener('click', async () => {
            showLoading();
            try {
                const provider = new GoogleAuthProvider();
                const result = await signInWithPopup(auth, provider);
                const user = result.user;

                // Check if user already exists in Firestore, if not, create
                const userDocRef = doc(db, 'artifacts', appId, 'users', user.uid);
                const userDocSnap = await getDoc(userDocRef);

                if (!userDocSnap.exists()) {
                    await setDoc(userDocRef, {
                        uid: user.uid,
                        name: user.displayName || 'Student',
                        email: user.email,
                        phone: user.phoneNumber || ''
                    });
                    
                    // Also save to students collection for admin panel
                    await setDoc(doc(db, 'artifacts', appId, 'public/data/students', user.uid), {
                        uid: user.uid,
                        name: user.displayName || 'Student',
                        phoneNumber: user.phoneNumber || '',
                        email: user.email,
                        createdAt: new Date()
                    });
                    
                    showMessage('Signed in with Google successfully! Welcome!');
                } else {
                    showMessage('Logged in with Google successfully!');
                }
            } catch (error) {
                console.error('Google Sign-In error:', error.code, error.message);
                let errorMessage = 'Google Sign-In failed. Please try again.';
                if (error.code === 'auth/popup-closed-by-user') {
                    errorMessage = 'Google Sign-In window closed.';
                }
                showMessage(errorMessage);
            } finally {
                hideLoading();
            }
        });

        logoutNav.addEventListener('click', async (e) => {
            e.preventDefault();
            await signOut(auth);
            showMessage('Logged out successfully!');
        });
        logoutNavMobile.addEventListener('click', async (e) => {
            e.preventDefault();
            await signOut(auth);
            showMessage('Logged out successfully!');
            mobileNavMenu.classList.add('hidden'); // Close mobile menu
        });

        // --- Navigation Logic ---
        homeNav.addEventListener('click', (e) => {
            e.preventDefault();
            showSection(homeSection);
            loadRecentFeed();
            loadPastResults(); // Load past results on home/dashboard
        });
        homeNavMobile.addEventListener('click', (e) => {
            e.preventDefault();
            showSection(homeSection);
            loadRecentFeed();
            loadPastResults();
            mobileNavMenu.classList.add('hidden');
        });
        profileNav.addEventListener('click', (e) => {
            e.preventDefault();
            showSection(profileSection);
            loadProfile();
        });
        profileNavMobile.addEventListener('click', (e) => {
            e.preventDefault();
            showSection(profileSection);
            loadProfile();
            mobileNavMenu.classList.add('hidden');
        });

        postsNav.addEventListener('click', (e) => {
            e.preventDefault();
            showSection(postsSection);
            loadPosts();
        });
        postsNavMobile.addEventListener('click', (e) => {
            e.preventDefault();
            showSection(postsSection);
            loadPosts();
            mobileNavMenu.classList.add('hidden');
        });

        profileNav.addEventListener('click', (e) => {
            e.preventDefault();
            showSection(profileSection);
            loadProfile();
        });
        profileNavMobile.addEventListener('click', (e) => {
            e.preventDefault();
            showSection(profileSection);
            loadProfile();
            mobileNavMenu.classList.add('hidden');
        });

        testCategoriesNav.addEventListener('click', (e) => {
            e.preventDefault();
            showSection(testCategoriesSection);
            loadTestCategoriesSection();
        });
        testCategoriesNavMobile.addEventListener('click', (e) => {
            e.preventDefault();
            showSection(testCategoriesSection);
            loadTestCategoriesSection();
            mobileNavMenu.classList.add('hidden');
        });

        postCategoriesNav.addEventListener('click', (e) => {
            e.preventDefault();
            showSection(postCategoriesSection);
            loadPostCategories();
        });
        postCategoriesNavMobile.addEventListener('click', (e) => {
            e.preventDefault();
            showSection(postCategoriesSection);
            loadPostCategories();
            mobileNavMenu.classList.add('hidden');
        });

        allTestsNav.addEventListener('click', (e) => {
            e.preventDefault();
            showSection(allTestsSection);
            loadAllTests();
        });
        allTestsNavMobile.addEventListener('click', (e) => {
            e.preventDefault();
            showSection(allTestsSection);
            loadAllTests();
            mobileNavMenu.classList.add('hidden');
        });

        mobileMenuBtn.addEventListener('click', () => {
            mobileNavMenu.classList.toggle('hidden');
        });

        // --- Data Loading Functions ---

        // Profile logic
        async function loadProfile() {
            if (!currentUser) return;
            showLoading();
            try {
                const userDocRef = doc(db, 'artifacts', appId, 'users', currentUser.uid);
                const userSnap = await getDoc(userDocRef);
                if (userSnap.exists()) {
                    const u = userSnap.data();
                    profileName.textContent = u.name || 'Student';
                    profileEmail.textContent = u.email || currentUser.email || 'N/A';
                    profilePhone.textContent = u.phone || u.phoneNumber || 'N/A';
                } else {
                    profileName.textContent = currentUser.displayName || 'Student';
                    profileEmail.textContent = currentUser.email || 'N/A';
                    profilePhone.textContent = currentUser.phoneNumber || 'N/A';
                }

                const resultsColRef = collection(db, 'artifacts', appId, 'public', 'data', 'results');
                const q = query(resultsColRef, where('userId', '==', currentUser.uid));
                const resultsSnap = await getDocs(q);
                let testsTaken = 0;
                let totalMarksVal = 0;
                resultsSnap.forEach(d => {
                    const r = d.data();
                    testsTaken += 1;
                    totalMarksVal += (r.score || 0);
                });
                profileTestsTaken.textContent = `${testsTaken}`;
                profileTotalMarks.textContent = `${totalMarksVal}`;
            } catch (e) {
                console.error('Error loading profile:', e);
                showMessage('Failed to load profile.');
            } finally {
                hideLoading();
            }
        }

        async function loadCategories() {
            showLoading();
            categoriesContainer.innerHTML = '';
            noCategoriesMessage.classList.add('hidden');
            try {
                const categoriesColRef = collection(db, 'artifacts', appId, 'public', 'data', 'categories');
                const q = query(categoriesColRef);
                const querySnapshot = await getDocs(q);

                if (querySnapshot.empty) {
                    noCategoriesMessage.classList.remove('hidden');
                    hideLoading();
                    return;
                }

                const categories = [];
                querySnapshot.forEach(doc => {
                    categories.push({ id: doc.id, ...doc.data() });
                });

                // No-op now; categories block removed from home.
            } catch (error) {
                console.error('Error loading categories:', error);
                showMessage('Failed to load categories. Please try again.');
            } finally {
                hideLoading();
            }
        }

        async function loadRecentFeed() {
            showLoading();
            recentFeedContainer.innerHTML = '';
            noRecentMessage.classList.add('hidden');
            try {
                const postsColRef = collection(db, 'artifacts', appId, 'public', 'data', 'posts');
                const testsColRef = collection(db, 'artifacts', appId, 'public', 'data', 'tests');
                const postsSnap = await getDocs(query(postsColRef, orderBy('createdAt', 'desc')));
                const testsSnap = await getDocs(query(testsColRef, orderBy('createdAt', 'desc')));

                const items = [];
                postsSnap.forEach(d => {
                    const data = d.data();
                    items.push({
                        id: d.id,
                        type: 'post',
                        createdAt: data.createdAt ? data.createdAt.toDate() : new Date(0),
                        data
                    });
                });
                testsSnap.forEach(d => {
                    const data = d.data();
                    items.push({
                        id: d.id,
                        type: 'test',
                        createdAt: data.createdAt ? data.createdAt.toDate() : new Date(0),
                        data
                    });
                });

                if (items.length === 0) {
                    noRecentMessage.classList.remove('hidden');
                    hideLoading();
                    return;
                }

                // Sort by createdAt desc
                items.sort((a, b) => b.createdAt.getTime() - a.createdAt.getTime());

                // Render up to 12 most recent alternating naturally by sort
                items.slice(0, 12).forEach(item => {
                    if (item.type === 'post') {
                    const postCard = document.createElement('div');
                    postCard.className = 'card p-6';
                        const desc = item.data.description || '';
                    postCard.innerHTML = `
                            <div class="flex items-start justify-between mb-2">
                                <h3 class="text-xl font-bold text-gray-800">${item.data.title}</h3>
                                <span class="text-xs px-2 py-1 bg-indigo-50 text-indigo-600 rounded">Post</span>
                        </div>
                            <p class="text-gray-600 mb-3 text-sm">${desc.substring(0, 120)}${desc.length > 120 ? '...' : ''}</p>
                            <div class="flex items-center justify-between text-sm text-gray-500 mb-4">
                                <span>${item.data.category || 'Uncategorized'}</span>
                                <span>${item.createdAt.toLocaleDateString()}</span>
                            </div>
                            <div class="flex items-center gap-3">
                                <button class="like-btn" data-type="post" data-id="${item.id}"><i class="far fa-heart mr-2"></i>Like</button>
                                <span class="text-sm text-gray-500" data-like-count="post:${item.id}">0</span>
                                ${item.data.links && item.data.links.length > 0 ? `<a href="${item.data.links[0]}" target="_blank" class="text-blue-600 hover:text-blue-800 text-sm"><i class="fas fa-external-link-alt mr-1"></i>Open</a>` : ''}
                            </div>
                        `;
                        recentFeedContainer.appendChild(postCard);
                    } else {
                        const testCard = document.createElement('div');
                        testCard.className = 'card p-6';
                        const qCount = item.data.questions ? item.data.questions.length : 0;
                        testCard.innerHTML = `
                            <div class="flex items-start justify-between mb-2">
                                <h3 class="text-xl font-bold text-gray-800">${item.data.title}</h3>
                                <span class="text-xs px-2 py-1 bg-emerald-50 text-emerald-600 rounded">Test</span>
                            </div>
                            <div class="flex items-center justify-between text-sm text-gray-500 mb-1">
                                <span>${item.data.category || 'Uncategorized'}</span>
                                <span>${item.createdAt.toLocaleDateString()}</span>
                            </div>
                            <p class="text-sm text-gray-600 mb-4">${qCount} questions</p>
                            <div class="flex items-center gap-3">
                                <button class="like-btn" data-type="test" data-id="${item.id}"><i class="far fa-heart mr-2"></i>Like</button>
                                <span class="text-sm text-gray-500" data-like-count="test:${item.id}">0</span>
                                <button class="btn-primary flex-1" onclick="startTest('${item.id}', '${item.data.title.replace(/'/g, "&#39;")}')">Start Test</button>
                            </div>
                        `;
                        recentFeedContainer.appendChild(testCard);
                    }
                });
                // Bind like buttons
                recentFeedContainer.querySelectorAll('.like-btn').forEach(btn => {
                    btn.addEventListener('click', async (e) => {
                        const el = e.currentTarget;
                        const itemType = el.getAttribute('data-type');
                        const itemId = el.getAttribute('data-id');
                        await toggleLike(itemType, itemId, el);
                    });
                });

                // Load like state and counts
                await Promise.all(items.slice(0, 12).map(async (item) => {
                    await updateLikeStateAndCount(item.type, item.id);
                }));

            } catch (error) {
                console.error('Error loading recent feed:', error);
                showMessage('Failed to load recent items.');
            } finally {
                hideLoading();
            }
        }

        async function toggleLike(itemType, itemId, buttonEl) {
            if (!currentUser) {
                showMessage('Please login to like items.');
                    return;
                }
            try {
                const likeDocRef = doc(db, 'artifacts', appId, 'public', 'data', itemType === 'post' ? 'posts' : 'tests', itemId, 'likes', currentUser.uid);
                const likeSnap = await getDoc(likeDocRef);
                if (likeSnap.exists()) {
                    await deleteDoc(likeDocRef);
                    buttonEl.innerHTML = '<i class="far fa-heart mr-2"></i>Like';
                } else {
                    await setDoc(likeDocRef, { userId: currentUser.uid, likedAt: new Date() });
                    buttonEl.innerHTML = '<i class="fas fa-heart text-rose-500 mr-2"></i>Liked';
                }
                await updateLikeStateAndCount(itemType, itemId);
            } catch (err) {
                console.error('Error toggling like:', err);
                showMessage('Could not update like.');
            }
        }

        async function updateLikeStateAndCount(itemType, itemId) {
            try {
                const likesColRef = collection(db, 'artifacts', appId, 'public', 'data', itemType === 'post' ? 'posts' : 'tests', itemId, 'likes');
                const likesSnap = await getDocs(likesColRef);
                const count = likesSnap.size;
                const countEl = document.querySelector(`[data-like-count="${itemType}:${itemId}"]`);
                if (countEl) countEl.textContent = `${count}`;

                if (currentUser) {
                    const likeDocRef = doc(db, 'artifacts', appId, 'public', 'data', itemType === 'post' ? 'posts' : 'tests', itemId, 'likes', currentUser.uid);
                    const likeSnap = await getDoc(likeDocRef);
                    const btn = document.querySelector(`.like-btn[data-type="${itemType}"][data-id="${itemId}"]`);
                    if (btn) btn.innerHTML = likeSnap.exists() ? '<i class="fas fa-heart text-rose-500 mr-2"></i>Liked' : '<i class="far fa-heart mr-2"></i>Like';
                }
            } catch (e) {
                console.error('Error loading like count:', e);
            }
        }

        async function loadPosts() {
            showLoading();
            postsContainer.innerHTML = '';
            noPostsFoundMessage.classList.add('hidden');
            
            try {
                let posts;
                
                // Check cache first
                if (isCacheValid('posts')) {
                    console.log('Using cached posts data');
                    posts = cachedData.posts;
                } else {
                    console.log('Fetching fresh posts data');
                    const postsColRef = collection(db, 'artifacts', appId, 'public', 'data', 'posts');
                    const q = query(postsColRef, orderBy('createdAt', 'desc'));
                    const querySnapshot = await getDocs(q);
                    
                    posts = [];
                    querySnapshot.forEach(doc => {
                        posts.push({ id: doc.id, ...doc.data() });
                    });
                    
                    // Cache the data
                    setCachedData('posts', posts);
                }

                if (posts.length === 0) {
                    noPostsFoundMessage.classList.remove('hidden');
                    hideLoading();
                    return;
                }

                // Render posts with improved UI
                posts.forEach(postData => {
                    const postCard = document.createElement('div');
                    postCard.className = 'card p-6 mb-4 hover:shadow-lg transition-shadow';
                    postCard.innerHTML = `
                        <h3 class="text-xl font-bold text-gray-800 mb-2">${postData.title}</h3>
                        <p class="text-gray-600 mb-3">${postData.description}</p>
                        <div class="flex items-center justify-between mb-3">
                            <span class="text-sm text-blue-600 bg-blue-50 px-2 py-1 rounded">${postData.category || 'Uncategorized'}</span>
                            <span class="text-sm text-gray-500">${postData.createdAt ? postData.createdAt.toDate().toLocaleDateString() : 'N/A'}</span>
                        </div>
                        ${postData.links && postData.links.length > 0 ? `
                            <div class="space-y-2">
                                <h4 class="text-sm font-semibold text-gray-700 mb-2">Study Resources:</h4>
                                ${postData.links.map(link => `
                                    <a href="${link}" target="_blank" class="block text-blue-600 hover:text-blue-800 text-sm p-2 bg-blue-50 rounded hover:bg-blue-100 transition-colors">
                                        <i class="fas fa-external-link-alt mr-2"></i>${link.includes('youtube.com') ? 'Watch Video' : 'View Resource'}
                                    </a>
                                `).join('')}
                            </div>
                        ` : ''}
                    `;
                    postsContainer.appendChild(postCard);
                });

            } catch (error) {
                console.error('Error loading posts:', error);
                showMessage('Failed to load posts. Please try again.');
            } finally {
                hideLoading();
            }
        }

        async function loadPostCategories() {
            showLoading();
            postCategoriesContainer.innerHTML = '';
            noPostCategoriesMessage.classList.add('hidden');
            
            try {
                let categories;
                
                // Check cache first
                if (isCacheValid('postCategories')) {
                    console.log('Using cached post categories data');
                    categories = cachedData.postCategories;
                } else {
                    console.log('Fetching fresh post categories data');
                    const postCategoriesColRef = collection(db, 'artifacts', appId, 'public', 'data', 'postCategories');
                    const querySnapshot = await getDocs(postCategoriesColRef);
                    
                    categories = [];
                    querySnapshot.forEach(doc => {
                        categories.push({ id: doc.id, ...doc.data() });
                    });
                    
                    // Cache the data
                    setCachedData('postCategories', categories);
                }

                if (categories.length === 0) {
                    noPostCategoriesMessage.classList.remove('hidden');
                    hideLoading();
                    return;
                }

                // Count posts per category for better UX (using cached posts if available)
                let postCounts = {};
                if (cachedData.posts) {
                    cachedData.posts.forEach(post => {
                        if (post.category) {
                            postCounts[post.category] = (postCounts[post.category] || 0) + 1;
                        }
                    });
                }

                categories.forEach(categoryData => {
                    const categoryCard = document.createElement('div');
                    categoryCard.className = 'card p-6 hover:shadow-lg transition-shadow cursor-pointer';
                    const postCount = postCounts[categoryData.title] || 0;
                    categoryCard.innerHTML = `
                        <div class="flex items-center justify-between mb-2">
                            <h3 class="text-xl font-bold text-gray-800">${categoryData.title}</h3>
                            <span class="text-sm bg-blue-100 text-blue-800 px-2 py-1 rounded">${postCount} posts</span>
                        </div>
                        <p class="text-gray-600 mb-4">${categoryData.description || 'Browse posts in this category.'}</p>
                        <button class="btn-primary w-full hover:bg-blue-700 transition-colors" onclick="loadPostsByCategory('${categoryData.title}')">
                            <i class="fas fa-folder-open mr-2"></i>View Posts
                        </button>
                    `;
                    postCategoriesContainer.appendChild(categoryCard);
                });

            } catch (error) {
                console.error('Error loading post categories:', error);
                showMessage('Failed to load post categories. Please try again.');
            } finally {
                hideLoading();
            }
        }

        async function loadTestCategoriesSection() {
            showLoading();
            testCategoriesContainer.innerHTML = '';
            noTestCategoriesMessage.classList.add('hidden');
            try {
                const categoriesColRef = collection(db, 'artifacts', appId, 'public', 'data', 'categories');
                const q = query(categoriesColRef);
                const querySnapshot = await getDocs(q);
                if (querySnapshot.empty) {
                    noTestCategoriesMessage.classList.remove('hidden');
                    hideLoading();
                    return;
                }
                querySnapshot.forEach(doc => {
                    const category = { id: doc.id, ...doc.data() };
                    const categoryCard = document.createElement('div');
                    categoryCard.className = 'card category-card p-4 rounded-lg shadow-md flex flex-col items-center justify-center text-center transform hover:scale-105 transition-transform duration-200';
                    categoryCard.innerHTML = `
                        <i class="fas fa-folder text-4xl text-blue-500 mb-3"></i>
                        <h3 class="text-xl font-semibold text-gray-800">${category.title}</h3>
                        <p class="text-gray-600 text-sm mt-1">Click to view tests</p>
                    `;
                    categoryCard.addEventListener('click', () => loadTestsByCategory(category.title));
                    testCategoriesContainer.appendChild(categoryCard);
                });
            } catch (error) {
                console.error('Error loading test categories section:', error);
                showMessage('Failed to load test categories.');
            } finally {
                hideLoading();
            }
        }

        async function loadTestsByCategory(categoryTitle) {
            showLoading();
            allTestsContainer.innerHTML = '';
            noTestsMessage.classList.add('hidden');
            testSearchInput.value = ''; // Clear search input
            showSection(allTestsSection); // Navigate to All Tests section

            try {
                const testsColRef = collection(db, 'artifacts', appId, 'public', 'data', 'tests');
                const q = query(testsColRef, where('category', '==', categoryTitle));
                const querySnapshot = await getDocs(q);

                if (querySnapshot.empty) {
                    noTestsMessage.classList.remove('hidden');
                    showMessage(`No tests found in ${categoryTitle} category.`);
                    hideLoading();
                    return;
                }

                const tests = [];
                querySnapshot.forEach(doc => {
                    tests.push({ id: doc.id, ...doc.data() });
                });
                displayTests(tests);

            } catch (error) {
                console.error('Error loading tests by category:', error);
                showMessage('Failed to load tests for this category. Please try again.');
            } finally {
                hideLoading();
            }
        }

        async function loadAllTests() {
            showLoading();
            allTestsContainer.innerHTML = '';
            noTestsMessage.classList.add('hidden');
            testSearchInput.value = ''; // Clear search input
            try {
                const testsColRef = collection(db, 'artifacts', appId, 'public', 'data', 'tests');
                const q = query(testsColRef);
                const querySnapshot = await getDocs(q);

                if (querySnapshot.empty) {
                    noTestsMessage.classList.remove('hidden');
                    showMessage('No tests found in the database.');
                    hideLoading();
                    return;
                }

                const tests = [];
                querySnapshot.forEach(doc => {
                    tests.push({ id: doc.id, ...doc.data() });
                });
                displayTests(tests);

            } catch (error) {
                console.error('Error loading all tests:', error);
                showMessage('Failed to load all tests. Please try again.');
            } finally {
                hideLoading();
            }
        }

        function displayTests(tests) {
            allTestsContainer.innerHTML = '';
            if (tests.length === 0) {
                noTestsMessage.classList.remove('hidden');
                return;
            }
            noTestsMessage.classList.add('hidden');

            tests.forEach(test => {
                const testCard = document.createElement('div');
                testCard.className = 'card test-card p-4 rounded-lg shadow-md flex flex-col justify-between';
                testCard.innerHTML = `
                    <div>
                        <h3 class="text-xl font-semibold text-gray-800 mb-2">${test.title}</h3>
                        <p class="text-sm text-gray-500 mb-3">Category: ${test.category}</p>
                        <p class="text-sm text-gray-600">${test.questions ? test.questions.length : 0} Questions</p>
                    </div>
                    <button class="mt-4 btn-primary text-sm py-2 px-4 rounded-md self-end">Take Test</button>
                `;
                testCard.querySelector('button').addEventListener('click', () => startTest(test.id, test.title));
                allTestsContainer.appendChild(testCard);
            });
        }

        testSearchInput.addEventListener('input', async (e) => {
            const searchTerm = e.target.value.toLowerCase();
            showLoading();
            try {
                const testsColRef = collection(db, 'artifacts', appId, 'public', 'data', 'tests');
                const q = query(testsColRef);
                const querySnapshot = await getDocs(q);
                let filteredTests = [];
                querySnapshot.forEach(doc => {
                    const testData = { id: doc.id, ...doc.data() };
                    if (testData.title.toLowerCase().includes(searchTerm)) {
                        filteredTests.push(testData);
                    }
                });
                displayTests(filteredTests);
            } catch (error) {
                console.error('Error searching tests:', error);
                showMessage('Error searching tests.');
            } finally {
                hideLoading();
            }
        });

        async function startTest(testId, testTitle) {
            showLoading();
            try {
                const testDocRef = doc(db, 'artifacts', appId, 'public', 'data', 'tests', testId);
                const testDocSnap = await getDoc(testDocRef);

                if (!testDocSnap.exists()) {
                    showMessage('Test not found!');
                    hideLoading();
                    return;
                }

                currentTest = testDocSnap.data();
                currentTestId = testId;
                currentTestTitle = testTitle;
                userAnswers = new Array(currentTest.questions.length).fill(null); // Initialize user answers
                renderTest();
                showSection(testPageSection);
            } catch (error) {
                console.error('Error starting test:', error);
                showMessage('Failed to load test. Please try again.');
            } finally {
                hideLoading();
            }
        }

        function renderTest() {
            testTitleElement.textContent = currentTest.title;
            questionsContainer.innerHTML = '';
            submitTestBtn.classList.add('hidden'); // Hide until questions are rendered

            if (!currentTest.questions || currentTest.questions.length === 0) {
                questionsContainer.innerHTML = '<p class="text-gray-600 text-center">No questions available for this test.</p>';
                return;
            }

            currentTest.questions.forEach((q, qIndex) => {
                const questionDiv = document.createElement('div');
                questionDiv.className = 'card p-5 rounded-lg shadow-sm';
                questionDiv.innerHTML = `
                    <p class="text-lg font-semibold text-gray-800 mb-4">Q${qIndex + 1}: ${q.questionText}</p>
                    <div class="options-group space-y-3" data-question-index="${qIndex}">
                        ${q.options.map((option, oIndex) => `
                            <button class="option-button w-full" data-option-index="${oIndex}">
                                ${String.fromCharCode(65 + oIndex)}. ${option}
                            </button>
                        `).join('')}
                    </div>
                `;
                questionsContainer.appendChild(questionDiv);
            });

            // Add event listeners for option selection
            questionsContainer.querySelectorAll('.options-group').forEach(group => {
                group.addEventListener('click', (e) => {
                    const clickedButton = e.target.closest('.option-button');
                    if (!clickedButton) return;

                    const questionIndex = parseInt(group.dataset.questionIndex);
                    const optionIndex = parseInt(clickedButton.dataset.optionIndex);

                    // Deselect previous option for this question
                    group.querySelectorAll('.option-button').forEach(btn => {
                        btn.classList.remove('selected');
                    });

                    // Select current option
                    clickedButton.classList.add('selected');
                    userAnswers[questionIndex] = optionIndex;

                    // Show submit button if all questions are answered
                    if (userAnswers.every(answer => answer !== null)) {
                        submitTestBtn.classList.remove('hidden');
                    }
                });
            });
        }

        submitTestBtn.addEventListener('click', async () => {
            if (!currentUser) {
                showMessage('You must be logged in to submit a test.');
                return;
            }

            if (!userAnswers.every(answer => answer !== null)) {
                showMessage('Please answer all questions before submitting.');
                return;
            }

            showLoading();
            let score = 0;
            currentTest.questions.forEach((q, index) => {
                if (userAnswers[index] === q.correctAnswerIndex) {
                    score++;
                }
            });

            try {
                await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'results'), {
                    userId: currentUser.uid,
                    testId: currentTestId,
                    testTitle: currentTest.title, // Store test title for easier display
                    score: score,
                    totalQuestions: currentTest.questions.length,
                    answers: userAnswers, // Store user's selected answers
                    submittedAt: serverTimestamp()
                });
                showMessage('Test submitted successfully!');
                displayResults(score, currentTest.questions.length);
            } catch (error) {
                console.error('Error submitting test:', error);
                showMessage('Failed to submit test. Please try again.');
            } finally {
                hideLoading();
            }
        });

        function displayResults(score, totalQuestions) {
            finalScore.textContent = `${score}`;
            scoreOutOf.textContent = `out of ${totalQuestions}`;
            reviewContainer.innerHTML = '';

            currentTest.questions.forEach((q, qIndex) => {
                const userAnswer = userAnswers[qIndex];
                const isCorrect = userAnswer === q.correctAnswerIndex;

                const reviewDiv = document.createElement('div');
                reviewDiv.className = `card p-5 rounded-lg shadow-sm ${isCorrect ? 'border-green-400' : 'border-red-400'} border-2`;
                reviewDiv.innerHTML = `
                    <p class="text-lg font-semibold text-gray-800 mb-3">Q${qIndex + 1}: ${q.questionText}</p>
                    <div class="options-group space-y-2">
                        ${q.options.map((option, oIndex) => {
                            let optionClass = 'option-button w-full cursor-default';
                            if (oIndex === q.correctAnswerIndex) {
                                optionClass += ' correct';
                            }
                            if (oIndex === userAnswer && !isCorrect) {
                                optionClass += ' incorrect';
                            } else if (oIndex === userAnswer && isCorrect) {
                                optionClass += ' selected'; // Keep selected style for correct answer
                            }
                            return `<button class="${optionClass}" data-option-index="${oIndex}">
                                ${String.fromCharCode(65 + oIndex)}. ${option}
                            </button>`;
                        }).join('')}
                    </div>
                    <p class="mt-3 text-sm ${isCorrect ? 'text-green-600' : 'text-red-600'}">
                        ${isCorrect ? '<i class="fas fa-check-circle mr-1"></i> Correct!' : '<i class="fas fa-times-circle mr-1"></i> Incorrect.'}
                        The correct answer was: ${String.fromCharCode(65 + q.correctAnswerIndex)}. ${q.options[q.correctAnswerIndex]}
                    </p>
                `;
                reviewContainer.appendChild(reviewDiv);
            });

            showSection(resultsSection);
        }

        takeAnotherTestBtn.addEventListener('click', () => {
            showSection(homeSection);
            loadRecentFeed();
            loadPastResults();
        });

        viewLeaderboardBtn.addEventListener('click', () => {
            if (currentTestId) {
                loadLeaderboard(currentTestId, currentTestTitle);
            } else {
                showMessage('No current test to view leaderboard for.');
            }
        });

        backToResultsBtn.addEventListener('click', () => {
            showSection(resultsSection);
        });

        async function loadLeaderboard(testId, testTitle) {
            showLoading();
            leaderboardTestTitle.textContent = testTitle;
            leaderboardBody.innerHTML = '';
            noLeaderboardData.classList.add('hidden');
            try {
                const resultsColRef = collection(db, 'artifacts', appId, 'public', 'data', 'results');
                // Note: Firestore orderBy requires an index. For simplicity and to avoid
                // requiring manual index creation, we'll fetch all and sort in JS.
                const q = query(resultsColRef, where('testId', '==', testId));
                const querySnapshot = await getDocs(q);

                if (querySnapshot.empty) {
                    noLeaderboardData.classList.remove('hidden');
                    hideLoading();
                    return;
                }

                let results = [];
                querySnapshot.forEach(doc => {
                    const data = doc.data();
                    results.push({
                        userId: data.userId,
                        score: data.score,
                        totalQuestions: data.totalQuestions,
                        submittedAt: data.submittedAt ? data.submittedAt.toDate() : new Date()
                    });
                });

                // Aggregate results by user - keep only the best score for each user
                const userBestScores = {};
                results.forEach(result => {
                    if (!userBestScores[result.userId] || result.score > userBestScores[result.userId].score) {
                        userBestScores[result.userId] = result;
                    }
                });

                // Convert back to array and sort by best score (descending)
                const aggregatedResults = Object.values(userBestScores).sort((a, b) => {
                    if (b.score !== a.score) {
                        return b.score - a.score;
                    }
                    return a.submittedAt.getTime() - b.submittedAt.getTime();
                });

                // Fetch user names for display
                const userPromises = aggregatedResults.map(async (result) => {
                    const userDocRef = doc(db, 'artifacts', appId, 'users', result.userId);
                    const userDocSnap = await getDoc(userDocRef);
                    return {
                        ...result,
                        userName: userDocSnap.exists() ? userDocSnap.data().name : 'Unknown User'
                    };
                });
                const populatedResults = await Promise.all(userPromises);

                populatedResults.forEach((result, index) => {
                    const row = document.createElement('tr');
                    row.className = 'bg-white';
                    row.innerHTML = `
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${index + 1}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${result.userName}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${result.score} / ${result.totalQuestions}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${result.submittedAt.toLocaleString()}</td>
                    `;
                    leaderboardBody.appendChild(row);
                });

            } catch (error) {
                console.error('Error loading leaderboard:', error);
                showMessage('Failed to load leaderboard. Please try again.');
            } finally {
                hideLoading();
                showSection(leaderboardSection);
            }
        }

        async function loadPostsByCategory(categoryTitle) {
            showLoading();
            postsContainer.innerHTML = '';
            noPostsFoundMessage.classList.add('hidden');
            
            // Switch to posts section first
            showSection(postsSection);
            
            try {
                let posts = [];
                
                // Try to use cached posts first for better performance
                if (isCacheValid('posts') && cachedData.posts) {
                    console.log('Using cached posts for category filtering');
                    posts = cachedData.posts.filter(post => post.category === categoryTitle);
                } else {
                    console.log('Fetching posts from database for category:', categoryTitle);
                    const postsColRef = collection(db, 'artifacts', appId, 'public', 'data', 'posts');
                    const q = query(postsColRef, where('category', '==', categoryTitle), orderBy('createdAt', 'desc'));
                    const querySnapshot = await getDocs(q);
                    
                    querySnapshot.forEach(doc => {
                        posts.push({ id: doc.id, ...doc.data() });
                    });
                }

                if (posts.length === 0) {
                    noPostsFoundMessage.classList.remove('hidden');
                    postsContainer.innerHTML = `
                        <div class="text-center py-8">
                            <i class="fas fa-folder-open text-4xl text-gray-400 mb-4"></i>
                            <p class="text-gray-600">No posts found in "${categoryTitle}" category.</p>
                            <button onclick="loadPostCategories(); showSection(postCategoriesSection);" class="btn-primary mt-4">
                                ← Back to Categories
                            </button>
                        </div>
                    `;
                    hideLoading();
                    return;
                }

                // Add category header with post count
                const categoryHeader = document.createElement('div');
                categoryHeader.className = 'mb-6 pb-4 border-b border-gray-200';
                categoryHeader.innerHTML = `
                    <div class="flex items-center justify-between">
                        <div>
                            <h2 class="text-2xl font-bold text-gray-800">Posts in "${categoryTitle}"</h2>
                            <p class="text-sm text-gray-600 mt-1">${posts.length} post${posts.length !== 1 ? 's' : ''} found</p>
                        </div>
                        <button onclick="loadPostCategories(); showSection(postCategoriesSection);" class="text-blue-600 hover:text-blue-800 flex items-center">
                            <i class="fas fa-arrow-left mr-2"></i>Back to Categories
                        </button>
                    </div>
                `;
                postsContainer.appendChild(categoryHeader);

                // Sort posts by creation date (most recent first)
                posts.sort((a, b) => {
                    const dateA = a.createdAt ? a.createdAt.toDate() : new Date(0);
                    const dateB = b.createdAt ? b.createdAt.toDate() : new Date(0);
                    return dateB.getTime() - dateA.getTime();
                });

                posts.forEach(postData => {
                    const postCard = document.createElement('div');
                    postCard.className = 'card p-6 mb-4 hover:shadow-lg transition-shadow';
                    postCard.innerHTML = `
                        <h3 class="text-xl font-bold text-gray-800 mb-2">${postData.title}</h3>
                        <p class="text-gray-600 mb-3">${postData.description}</p>
                        <div class="flex items-center justify-between mb-3">
                            <span class="text-sm text-blue-600 bg-blue-50 px-2 py-1 rounded">${postData.category || 'Uncategorized'}</span>
                            <span class="text-sm text-gray-500">${postData.createdAt ? postData.createdAt.toDate().toLocaleDateString() : 'N/A'}</span>
                        </div>
                        ${postData.links && postData.links.length > 0 ? `
                            <div class="space-y-2">
                                <h4 class="text-sm font-semibold text-gray-700 mb-2">Study Resources:</h4>
                                ${postData.links.map(link => `
                                    <a href="${link}" target="_blank" class="block text-blue-600 hover:text-blue-800 text-sm p-2 bg-blue-50 rounded hover:bg-blue-100 transition-colors">
                                        <i class="fas fa-external-link-alt mr-2"></i>${link.includes('youtube.com') ? 'Watch Video' : 'View Resource'}
                                    </a>
                                `).join('')}
                            </div>
                        ` : ''}
                    `;
                    postsContainer.appendChild(postCard);
                });

            } catch (error) {
                console.error('Error loading posts by category:', error);
                showMessage('Failed to load posts for this category. Please try again.');
            } finally {
                hideLoading();
            }
        }

        async function loadPastResults() {
            if (!currentUser) {
                pastResultsBody.innerHTML = '';
                noPastResultsData.classList.remove('hidden');
                return;
            }

            showLoading();
            pastResultsBody.innerHTML = '';
            noPastResultsData.classList.add('hidden');
            try {
                const resultsColRef = collection(db, 'artifacts', appId, 'public', 'data', 'results');
                const q = query(resultsColRef, where('userId', '==', currentUser.uid));
                const querySnapshot = await getDocs(q);

                if (querySnapshot.empty) {
                    noPastResultsData.classList.remove('hidden');
                    hideLoading();
                    return;
                }

                let results = [];
                querySnapshot.forEach(doc => {
                    const data = doc.data();
                    results.push({
                        id: doc.id,
                        testTitle: data.testTitle,
                        score: data.score,
                        totalQuestions: data.totalQuestions,
                        submittedAt: data.submittedAt ? data.submittedAt.toDate() : new Date()
                    });
                });

                // Sort by most recent
                results.sort((a, b) => b.submittedAt.getTime() - a.submittedAt.getTime());

                results.forEach(result => {
                    const row = document.createElement('tr');
                    row.className = 'bg-white';
                    row.innerHTML = `
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${result.testTitle}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${result.score} / ${result.totalQuestions}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${result.submittedAt.toLocaleString()}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                            <button class="text-indigo-600 hover:text-indigo-900 review-past-test-btn" data-test-id="${result.testId}" data-result-id="${result.id}">Review</button>
                        </td>
                    `;
                    pastResultsBody.appendChild(row);
                });

                // Add event listeners for review buttons
                document.querySelectorAll('.review-past-test-btn').forEach(button => {
                    button.addEventListener('click', (e) => {
                        const testId = e.target.dataset.testId;
                        const resultId = e.target.dataset.resultId;
                        reviewPastTest(testId, resultId);
                    });
                });

            } catch (error) {
                console.error('Error loading past results:', error);
                showMessage('Failed to load past results.');
            } finally {
                hideLoading();
            }
        }

        async function reviewPastTest(testId, resultId) {
            showLoading();
            try {
                const testDocRef = doc(db, 'artifacts', appId, 'public', 'data', 'tests', testId);
                const testDocSnap = await getDoc(testDocRef);

                const resultDocRef = doc(db, 'artifacts', appId, 'public', 'data', 'results', resultId);
                const resultDocSnap = await getDoc(resultDocRef);

                if (!testDocSnap.exists() || !resultDocSnap.exists()) {
                    showMessage('Test or result data not found for review.');
                    hideLoading();
                    return;
                }

                currentTest = testDocSnap.data();
                userAnswers = resultDocSnap.data().answers;
                currentTestId = testId; // Set for leaderboard access
                currentTestTitle = currentTest.title; // Set for leaderboard access

                displayResults(resultDocSnap.data().score, currentTest.questions.length);
            } catch (error) {
                console.error('Error reviewing past test:', error);
                showMessage('Failed to review past test. Please try again.');
            } finally {
                hideLoading();
            }
        }


        // --- Authentication State Change Listener ---
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                currentUser = user;
                authSection.classList.add('hidden');
                contentSection.classList.remove('hidden');

                // Fetch user data from Firestore (with caching)
                try {
                    const userDocRef = doc(db, 'artifacts', appId, 'users', user.uid);
                    const userDocSnap = await getDoc(userDocRef);

                    if (userDocSnap.exists()) {
                        const userData = userDocSnap.data();
                        userNameDisplay.textContent = userData.name || userData.email;
                        
                        // Cache user data for faster subsequent loads
                        localStorage.setItem(`user_${user.uid}`, JSON.stringify(userData));
                        
                        // Check if 'name' was just set (implies first login via email/pass signup)
                        // Or if it's a new Google sign-in where displayName wasn't saved before
                        if (userData.name === 'Student' && !user.displayName) { // Basic check for first login
                             firstLoginMessage.classList.remove('hidden');
                        } else {
                            firstLoginMessage.classList.add('hidden');
                        }
                    } else {
                        // This case should ideally not happen if user creation is handled correctly
                        // but as a fallback, display email
                        userNameDisplay.textContent = user.email;
                        firstLoginMessage.classList.remove('hidden'); // Treat as first login
                    }
                } catch (error) {
                    console.error('Error fetching user data:', error);
                    // Try to use cached user data
                    const cachedUserData = localStorage.getItem(`user_${user.uid}`);
                    if (cachedUserData) {
                        const userData = JSON.parse(cachedUserData);
                        userNameDisplay.textContent = userData.name || userData.email;
                    } else {
                        userNameDisplay.textContent = user.email;
                    }
                }

                // Initial data load for authenticated users (optimized for performance)
                showSection(homeSection);
                
                // Load critical data immediately
                loadRecentFeed();
                loadPastResults();
                
                // Preload other data in background for better navigation experience
                setTimeout(() => {
                    if (!isCacheValid('posts')) {
                        loadPosts().catch(console.error);
                    }
                    if (!isCacheValid('postCategories')) {
                        loadPostCategories().catch(console.error);
                    }
                }, 1000);

                // Setup lazy loading after DOM is ready
                setTimeout(setupLazyLoading, 1500);

            } else {
                currentUser = null;
                authSection.classList.remove('hidden');
                contentSection.classList.add('hidden');
                // Reset auth form to login mode
                loginToggle.click();
                emailInput.value = '';
                passwordInput.value = '';
                nameInput.value = '';
                phoneInput.value = '';
                welcomeMessage.classList.add('hidden'); // Hide welcome message on logout
                
                // Clear sensitive cached data on logout
                Object.keys(localStorage).forEach(key => {
                    if (key.startsWith('user_') || key.startsWith('otp_')) {
                        localStorage.removeItem(key);
                    }
                });
            }
        });

        // --- Initial Firebase Authentication for Canvas Environment ---
        window.onload = async function() {
            // Check if this is an email link verification
            if (isSignInWithEmailLink(auth, window.location.href)) {
                const email = localStorage.getItem('emailForSignIn');
                const userData = JSON.parse(localStorage.getItem('emailLinkUserData') || '{}');
                
                if (email && userData.email === email) {
                    try {
                        await completeEmailLinkSignup(email, userData);
                        return; // Don't proceed with anonymous signin
                    } catch (error) {
                        console.error('Error completing email link signup:', error);
                        showMessage('Failed to complete email verification. Please try signing up again.');
                    }
                } else {
                    // Handle case where email link is clicked but no stored data
                    const urlParams = new URLSearchParams(window.location.search);
                    const emailFromUrl = urlParams.get('email');
                    if (emailFromUrl) {
                        showMessage('Please complete the signup process by clicking the link from the same browser and device where you signed up.');
                    }
                    // Clean up URL
                    window.history.replaceState({}, document.title, window.location.pathname);
                }
            }

            // Standard Firebase initialization
            if (initialAuthToken) {
                try {
                    await signInWithCustomToken(auth, initialAuthToken);
                    console.log("Signed in with custom token.");
                } catch (error) {
                    console.error("Error signing in with custom token:", error);
                    // Fallback to anonymous if custom token fails
                    try {
                        await signInAnonymously(auth);
                        console.log("Signed in anonymously as fallback.");
                    } catch (anonError) {
                        console.error("Error signing in anonymously:", anonError);
                    }
                }
            } else {
                try {
                    await signInAnonymously(auth);
                    console.log("Signed in anonymously (no custom token provided).");
                } catch (error) {
                    console.error("Error signing in anonymously:", error);
                }
            }
        };

        // --- Firestore Data Seeding (for initial setup) ---
        // You can run this once to populate your Firestore with some initial data.
        // REMEMBER TO REMOVE OR COMMENT OUT THIS SECTION AFTER INITIAL SEEDING
        // OR ADD A CHECK TO PREVENT REPEATED EXECUTION IN PRODUCTION.

        // async function seedFirestore() {
        //     console.log("Seeding Firestore...");
        //     showLoading();
        //     try {
        //         // Add categories
        //         await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'categories', 'math'), { title: 'Mathematics' });
        //         await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'categories', 'science'), { title: 'Science' });
        //         await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'categories', 'history'), { title: 'History' });
        //         await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'categories', 'programming'), { title: 'Programming' });

        //         // Add tests
        //         await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'tests', 'algebraBasics'), {
        //             title: 'Algebra Basics',
        //             category: 'Mathematics',
        //             questions: [
        //                 { questionText: 'What is 2 + 2?', options: ['3', '4', '5', '6'], correctAnswerIndex: 1 },
        //                 { questionText: 'Solve for x: x + 5 = 10', options: ['3', '4', '5', '6'], correctAnswerIndex: 2 },
        //                 { questionText: 'If y = 3x and x = 4, what is y?', options: ['7', '10', '12', '15'], correctAnswerIndex: 2 },
        //                 { questionText: 'Simplify: 2x + 3x', options: ['5', '6x', '5x', 'x'], correctAnswerIndex: 2 },
        //                 { questionText: 'What is the square root of 9?', options: ['2', '3', '4', '81'], correctAnswerIndex: 1 }
        //             ]
        //         });

        //         await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'tests', 'physicsFundamentals'), {
        //             title: 'Physics Fundamentals',
        //             category: 'Science',
        //             questions: [
        //                 { questionText: 'What is the SI unit of force?', options: ['Joule', 'Watt', 'Newton', 'Volt'], correctAnswerIndex: 2 },
        //                 { questionText: 'Which law states that for every action, there is an equal and opposite reaction?', options: ['Newton\'s First Law', 'Newton\'s Second Law', 'Newton\'s Third Law', 'Law of Conservation of Energy'], correctAnswerIndex: 2 },
        //                 { questionText: 'What is the formula for kinetic energy?', options: ['mgh', '1/2mv^2', 'F=ma', 'P=IV'], correctAnswerIndex: 1 },
        //                 { questionText: 'What is the speed of light in a vacuum (approximate)?', options: ['3x10^5 m/s', '3x10^8 m/s', '3x10^10 m/s', '3x10^12 m/s'], correctAnswerIndex: 1 }
        //             ]
        //         });

        //         await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'tests', 'worldHistory'), {
        //             title: 'World War II History',
        //             category: 'History',
        //             questions: [
        //                 { questionText: 'When did World War II begin?', options: ['1938', '1939', '1940', '1941'], correctAnswerIndex: 1 },
        //                 { questionText: 'Which country was NOT an Axis power?', options: ['Germany', 'Italy', 'Japan', 'United States'], correctAnswerIndex: 3 },
        //                 { questionText: 'Who was the Prime Minister of the United Kingdom during most of WWII?', options: ['Neville Chamberlain', 'Winston Churchill', 'Clement Attlee', 'Franklin D. Roosevelt'], correctAnswerIndex: 1 }
        //             ]
        //         });

        //         await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'tests', 'javascriptBasics'), {
        //             title: 'JavaScript Basics',
        //             category: 'Programming',
        //             questions: [
        //                 { questionText: 'What keyword is used to declare a variable in JavaScript?', options: ['var', 'let', 'const', 'All of the above'], correctAnswerIndex: 3 },
        //                 { questionText: 'Which method is used to print something to the console?', options: ['console.log()', 'print()', 'log.console()', 'display()'], correctAnswerIndex: 0 },
        //                 { questionText: 'What is the result of 5 + "5"?', options: ['10', '55', 'Error', 'Undefined'], correctAnswerIndex: 1 },
        //                 { questionText: 'Which operator is used for strict equality?', options: ['==', '!=', '===', '!=='], correctAnswerIndex: 2 }
        //             ]
        //         });

        //         showMessage("Firestore seeded successfully!");
        //     } catch (error) {
        //         console.error("Error seeding Firestore:", error);
        //         showMessage("Failed to seed Firestore.");
        //     } finally {
        //         hideLoading();
        //     }
        // }

        // Uncomment the line below and run once to seed your database
        // window.addEventListener('load', seedFirestore);

    </script>
</body>
</html>
